name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # åç«¯Goä»£ç æ£€æŸ¥å’Œæµ‹è¯•
  backend:
    name: Backend Go
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        cache-dependency-path: im-backend/go.sum
    
    - name: å®‰è£…ä¾èµ–
      working-directory: ./im-backend
      run: go mod download
    
    - name: Goæ ¼å¼æ£€æŸ¥
      working-directory: ./im-backend
      run: |
        if [ -n "$(gofmt -l .)" ]; then
          echo "Goä»£ç éœ€è¦æ ¼å¼åŒ–:"
          gofmt -l .
          exit 1
        fi
    
    - name: Go Veté™æ€åˆ†æ
      working-directory: ./im-backend
      run: go vet ./...
    
    - name: å®‰è£…golangci-lint
      run: |
        curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
    
    - name: GolangCI-Lintä»£ç è´¨é‡æ£€æŸ¥
      working-directory: ./im-backend
      run: golangci-lint run --timeout 5m
    
    - name: å®‰è£…gosec
      run: go install github.com/securego/gosec/v2/cmd/gosec@latest
    
    - name: GoSecå®‰å…¨æ‰«æ
      working-directory: ./im-backend
      run: gosec -fmt=json -out=gosec-report.json ./... || true
    
    - name: ä¸Šä¼ å®‰å…¨æ‰«ææŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: gosec-report
        path: im-backend/gosec-report.json
    
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      working-directory: ./im-backend
      run: go test -v -race -coverprofile=coverage.out ./...
    
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: im-backend/coverage.out
    
    - name: æ„å»ºæ£€æŸ¥
      working-directory: ./im-backend
      run: go build -v ./...

  # å‰ç«¯ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
  frontend:
    name: Frontend Admin
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Nodeç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: im-admin/package-lock.json
    
    - name: å®‰è£…ä¾èµ–
      working-directory: ./im-admin
      run: npm ci
    
    - name: ESLintä»£ç æ£€æŸ¥
      working-directory: ./im-admin
      run: npm run lint || true
    
    - name: ç±»å‹æ£€æŸ¥ï¼ˆå¦‚æœæœ‰TypeScriptï¼‰
      working-directory: ./im-admin
      run: |
        if [ -f "tsconfig.json" ]; then
          npx vue-tsc --noEmit || true
        fi
    
    - name: æ„å»ºæ£€æŸ¥
      working-directory: ./im-admin
      run: npm run build
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: admin-dist
        path: im-admin/dist

  # Dockeré•œåƒæ„å»ºæµ‹è¯•
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: æ„å»ºåç«¯é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./im-backend
        file: ./im-backend/Dockerfile.production
        push: false
        tags: im-backend:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: æ„å»ºç®¡ç†é¢æ¿é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./im-admin
        file: ./im-admin/Dockerfile.production
        push: false
        tags: im-admin:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # å®‰å…¨æ‰«æ
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: è¿è¡ŒTrivyæ¼æ´æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'
      continue-on-error: true
    
    - name: ä¸Šä¼ Trivyæ‰«æç»“æœ
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  # é…ç½®æ–‡ä»¶éªŒè¯
  config:
    name: Config Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: éªŒè¯Docker Composeæ–‡ä»¶
      run: |
        docker-compose -f docker-compose.production.yml config > /dev/null
        docker-compose -f docker-compose.dev.yml config > /dev/null
    
    - name: éªŒè¯YAMLæ–‡ä»¶
      run: |
        sudo apt-get install -y yamllint
        find . -name "*.yml" -o -name "*.yaml" | xargs yamllint -d relaxed
    
    - name: æ£€æŸ¥ç¯å¢ƒå˜é‡æ¨¡æ¿
      run: |
        if [ ! -f "ENV_STRICT_TEMPLATE.md" ]; then
          echo "âŒ ç¼ºå°‘ENV_STRICT_TEMPLATE.md"
          exit 1
        fi
        echo "âœ… ç¯å¢ƒå˜é‡æ¨¡æ¿å­˜åœ¨: ENV_STRICT_TEMPLATE.md"

  # æ±‡æ€»æŠ¥å‘Š
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend, docker, security, config]
    if: always()
    
    steps:
    - name: æ£€æŸ¥CIç»“æœ
      run: |
        echo "ğŸ‰ æ‰€æœ‰CIæ£€æŸ¥å®Œæˆï¼"
        echo "Backend: ${{ needs.backend.result }}"
        echo "Frontend: ${{ needs.frontend.result }}"
        echo "Docker: ${{ needs.docker.result }}"
        echo "Security: ${{ needs.security.result }}"
        echo "Config: ${{ needs.config.result }}"
