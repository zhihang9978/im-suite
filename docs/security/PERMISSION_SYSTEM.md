# æƒé™ç³»ç»Ÿé…ç½®æ–‡æ¡£

## ğŸ“‹ æƒé™çº§åˆ«è¯´æ˜

### ä¸‰çº§æƒé™ä½“ç³»

| è§’è‰² | æƒé™çº§åˆ« | è¯´æ˜ | å¯è®¿é—®åŠŸèƒ½ |
|------|---------|------|----------|
| **user** | æ™®é€šç”¨æˆ· | é»˜è®¤è§’è‰² | åŸºç¡€é€šè®¯åŠŸèƒ½ |
| **admin** | ç®¡ç†å‘˜ | ä¸­çº§æƒé™ | ç”¨æˆ·ç®¡ç†ã€å†…å®¹å®¡æ ¸ |
| **super_admin** | è¶…çº§ç®¡ç†å‘˜ | æœ€é«˜æƒé™ | å…¨éƒ¨åŠŸèƒ½ + ç³»ç»Ÿç®¡ç† |

---

## ğŸ” å½“å‰æƒé™é…ç½®

### 1. å…¬å¼€è·¯ç”±ï¼ˆæ— éœ€ç™»å½•ï¼‰
```go
/api/auth/login           - ç”¨æˆ·ç™»å½•
/api/auth/register        - ç”¨æˆ·æ³¨å†Œ
/api/auth/login/2fa       - 2FAéªŒè¯ç™»å½•
/api/auth/2fa/validate    - 2FAéªŒè¯
/health                   - å¥åº·æ£€æŸ¥
```

**æƒé™**: âœ… æ— éœ€è®¤è¯

---

### 2. å—ä¿æŠ¤è·¯ç”±ï¼ˆéœ€è¦ç™»å½•ï¼‰
```go
/api/messages/*           - æ¶ˆæ¯ç®¡ç†
/api/users/*              - ç”¨æˆ·ä¸ªäººä¿¡æ¯
/api/files/*              - æ–‡ä»¶ç®¡ç†
/api/2fa/*                - 2FAä¸ªäººè®¾ç½®
/api/devices/*            - è®¾å¤‡ä¸ªäººç®¡ç†
/api/themes/*             - ä¸»é¢˜è®¾ç½®
/api/moderation/reports   - å†…å®¹ä¸¾æŠ¥
```

**æƒé™**: âœ… éœ€è¦JWTè®¤è¯ï¼ˆä»»ä½•å·²ç™»å½•ç”¨æˆ·ï¼‰  
**ä¸­é—´ä»¶**: `AuthMiddleware()`

**è¯´æ˜**: è¿™äº›æ˜¯ç”¨æˆ·ä¸ªäººåŠŸèƒ½ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½å¯ä»¥ç®¡ç†è‡ªå·±çš„è®¾ç½®ã€‚

---

### 3. è¶…çº§ç®¡ç†å‘˜è·¯ç”±ï¼ˆéœ€è¦super_adminï¼‰
```go
/api/super-admin/stats                    - ç³»ç»Ÿç»Ÿè®¡
/api/super-admin/users/online             - åœ¨çº¿ç”¨æˆ·
/api/super-admin/users/:id/logout         - å¼ºåˆ¶ä¸‹çº¿
/api/super-admin/users/:id/ban            - å°ç¦ç”¨æˆ·
/api/super-admin/users/:id/unban          - è§£å°ç”¨æˆ·
/api/super-admin/users/:id                - åˆ é™¤ç”¨æˆ·
/api/super-admin/users/:id/analysis       - ç”¨æˆ·åˆ†æ
/api/super-admin/alerts                   - ç³»ç»Ÿå‘Šè­¦
/api/super-admin/logs                     - ç®¡ç†æ—¥å¿—
/api/super-admin/broadcast                - ç³»ç»Ÿå¹¿æ’­
```

**æƒé™**: âœ… éœ€è¦super_adminè§’è‰²  
**ä¸­é—´ä»¶**: `AuthMiddleware()` + `SuperAdmin()`

**è¯´æ˜**: è¿™äº›æ˜¯ç³»ç»Ÿç®¡ç†åŠŸèƒ½ï¼Œåªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®ã€‚

---

## ğŸ¯ ç®¡ç†åå°æƒé™è¦æ±‚

### im-adminç®¡ç†åå°è®¿é—®

#### æ¨èé…ç½®ï¼šAdminæˆ–Super_Admin â­

**æ–¹å¼1ï¼šå‰ç«¯è·¯ç”±å®ˆå«ï¼ˆæ¨èï¼‰**

ç¼–è¾‘ `im-admin/src/router/index.js`:

```javascript
// è·¯ç”±å®ˆå«
router.beforeEach((to, from, next) => {
  const userStore = useUserStore()
  
  if (to.meta.requiresAuth && !userStore.isLoggedIn) {
    next('/login')
  } else if (to.path === '/login' && userStore.isLoggedIn) {
    // æ£€æŸ¥ç”¨æˆ·è§’è‰²
    if (userStore.user.role === 'user') {
      // æ™®é€šç”¨æˆ·ä¸å…è®¸è®¿é—®ç®¡ç†åå°
      alert('éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½è®¿é—®')
      next(false)
      return
    }
    next('/')
  } else {
    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    if (to.meta.requiresAdmin && userStore.user.role === 'user') {
      alert('éœ€è¦ç®¡ç†å‘˜æƒé™')
      next('/')
      return
    }
    next()
  }
})
```

**æ–¹å¼2ï¼šåˆ›å»ºAdminä¸­é—´ä»¶**

åˆ›å»º `im-backend/internal/middleware/admin.go`:

```go
package middleware

import (
	"net/http"
	"zhihang-messenger/im-backend/config"
	"zhihang-messenger/im-backend/internal/model"
	"github.com/gin-gonic/gin"
)

// Admin ç®¡ç†å‘˜æƒé™ä¸­é—´ä»¶ï¼ˆadminæˆ–super_adminï¼‰
func Admin() gin.HandlerFunc {
	return func(c *gin.Context) {
		userID, exists := c.Get("user_id")
		if !exists {
			c.JSON(http.StatusUnauthorized, gin.H{
				"error": "æœªæˆæƒè®¿é—®",
			})
			c.Abort()
			return
		}

		// æŸ¥è¯¢ç”¨æˆ·è§’è‰²
		var user model.User
		if err := config.DB.First(&user, userID).Error; err != nil {
			c.JSON(http.StatusUnauthorized, gin.H{
				"error": "ç”¨æˆ·ä¸å­˜åœ¨",
			})
			c.Abort()
			return
		}

		// æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜
		if user.Role != "admin" && user.Role != "super_admin" {
			c.JSON(http.StatusForbidden, gin.H{
				"error": "éœ€è¦ç®¡ç†å‘˜æƒé™",
			})
			c.Abort()
			return
		}

		c.Next()
	}
}
```

---

## âœ… v1.4.0 æƒé™é…ç½®çŠ¶æ€

### 2FAè®¾ç½® - ç”¨æˆ·çº§åˆ« âœ… æ­£ç¡®

**é…ç½®**: `protected.Group("/2fa")`  
**æƒé™**: AuthMiddlewareï¼ˆç™»å½•ç”¨æˆ·ï¼‰  
**åŸå› **: æ¯ä¸ªç”¨æˆ·éƒ½åº”è¯¥èƒ½ç®¡ç†è‡ªå·±çš„2FA

**è¿™æ˜¯æ­£ç¡®çš„ï¼** âœ…

---

### è®¾å¤‡ç®¡ç† - ç”¨æˆ·çº§åˆ« âœ… æ­£ç¡®

**é…ç½®**: `protected.Group("/devices")`  
**æƒé™**: AuthMiddlewareï¼ˆç™»å½•ç”¨æˆ·ï¼‰  
**åŸå› **: æ¯ä¸ªç”¨æˆ·éƒ½åº”è¯¥èƒ½ç®¡ç†è‡ªå·±çš„è®¾å¤‡

**è¿™æ˜¯æ­£ç¡®çš„ï¼** âœ…

---

### è¶…çº§ç®¡ç†å‘˜åŠŸèƒ½ - Super_Adminçº§åˆ« âœ… æ­£ç¡®

**é…ç½®**: `superAdmin.Group("/super-admin")`  
**æƒé™**: AuthMiddleware + SuperAdmin  
**åŸå› **: ç³»ç»Ÿç®¡ç†åŠŸèƒ½ï¼Œåªæœ‰è¶…çº§ç®¡ç†å‘˜å¯è®¿é—®

**è¿™æ˜¯æ­£ç¡®çš„ï¼** âœ…

---

## ğŸ¯ å»ºè®®çš„æƒé™ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### 1. ç®¡ç†åå°è®¿é—®æ§åˆ¶ï¼ˆæ¨èï¼‰

**åœºæ™¯**: ç®¡ç†åå°ï¼ˆim-adminï¼‰åº”è¯¥åªå…è®¸adminå’Œsuper_adminè®¿é—®

**å®ç°æ–¹å¼**ï¼š

#### æ–¹å¼Aï¼šå‰ç«¯æ§åˆ¶ï¼ˆç®€å•ï¼‰
åœ¨ `im-admin/src/router/index.js` æ·»åŠ è§’è‰²æ£€æŸ¥

#### æ–¹å¼Bï¼šåç«¯æ§åˆ¶ï¼ˆå®‰å…¨ï¼‰
åˆ›å»ºAdminä¸­é—´ä»¶ï¼Œä¿æŠ¤ç®¡ç†ç›¸å…³API

#### æ–¹å¼Cï¼šç»¼åˆæ–¹æ¡ˆï¼ˆæ¨èï¼‰
å‰ç«¯+åç«¯åŒé‡éªŒè¯

---

### 2. æ•æ„ŸåŠŸèƒ½çš„ç®¡ç†å‘˜æŸ¥çœ‹ï¼ˆå¯é€‰ï¼‰

**åœºæ™¯**: ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„è®¾å¤‡å’Œ2FAçŠ¶æ€

**æ–°å¢åŠŸèƒ½**ï¼š
```go
// ç®¡ç†å‘˜ä¸“ç”¨è·¯ç”±
adminRoutes := api.Group("/admin")
adminRoutes.Use(middleware.AuthMiddleware())
adminRoutes.Use(middleware.Admin()) // éœ€è¦adminæˆ–super_admin

{
    // æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„2FAçŠ¶æ€
    adminRoutes.GET("/users/:id/2fa/status", ...)
    
    // æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„è®¾å¤‡
    adminRoutes.GET("/users/:id/devices", ...)
    
    // å¼ºåˆ¶é‡ç½®ç”¨æˆ·2FA
    adminRoutes.POST("/users/:id/2fa/reset", ...)
}
```

---

## ğŸ“Š å½“å‰æƒé™çŸ©é˜µ

| åŠŸèƒ½ | user | admin | super_admin |
|------|------|-------|-------------|
| ç™»å½•/æ³¨å†Œ | âœ… | âœ… | âœ… |
| å‘é€æ¶ˆæ¯ | âœ… | âœ… | âœ… |
| ç®¡ç†è‡ªå·±çš„2FA | âœ… | âœ… | âœ… |
| ç®¡ç†è‡ªå·±çš„è®¾å¤‡ | âœ… | âœ… | âœ… |
| æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯ | âœ… | âœ… | âœ… |
| **è®¿é—®ç®¡ç†åå°** | â“ | âœ… å»ºè®® | âœ… |
| **å†…å®¹å®¡æ ¸** | âŒ | âœ… | âœ… |
| **ç”¨æˆ·ç®¡ç†** | âŒ | âœ… | âœ… |
| **ç³»ç»Ÿç»Ÿè®¡** | âŒ | âŒ | âœ… |
| **å¼ºåˆ¶ä¸‹çº¿** | âŒ | âŒ | âœ… |
| **å°ç¦ç”¨æˆ·** | âŒ | âŒ | âœ… |
| **åˆ é™¤ç”¨æˆ·** | âŒ | âŒ | âœ… |
| **ç³»ç»Ÿå¹¿æ’­** | âŒ | âŒ | âœ… |

---

## âœ… ç»“è®º

### å½“å‰é…ç½®ï¼šæ­£ç¡®ä¸”åˆç† âœ…

**ç°æœ‰æƒé™é…ç½®æ˜¯æ­£ç¡®çš„**ï¼š
- âœ… ç”¨æˆ·ä¸ªäººåŠŸèƒ½ï¼ˆ2FAã€è®¾å¤‡ï¼‰- ä»»ä½•ç”¨æˆ·å¯è®¿é—®
- âœ… ç³»ç»Ÿç®¡ç†åŠŸèƒ½ - ä»…super_adminå¯è®¿é—®
- âœ… æƒé™ä¸­é—´ä»¶é…ç½®æ­£ç¡®

### å»ºè®®ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

**å¦‚æœéœ€è¦é™åˆ¶ç®¡ç†åå°è®¿é—®**ï¼š
1. å‰ç«¯æ·»åŠ è§’è‰²æ£€æŸ¥ï¼ˆ10åˆ†é’Ÿï¼‰
2. æˆ–åˆ›å»ºAdminä¸­é—´ä»¶ï¼ˆ15åˆ†é’Ÿï¼‰

**å¦‚æœéœ€è¦ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çŠ¶æ€**ï¼š
1. æ–°å¢ç®¡ç†å‘˜ä¸“ç”¨APIï¼ˆ30åˆ†é’Ÿï¼‰
2. æ·»åŠ Adminä¸­é—´ä»¶ä¿æŠ¤ï¼ˆå·²å‡†å¤‡å¥½ä»£ç ï¼‰

---

## ğŸ¤” éœ€è¦æ‚¨ç¡®è®¤

**é—®é¢˜**: æ‚¨è¯´"åå°æ‹¥æœ‰æœ€é«˜çº§åˆ«æƒé™"ï¼Œæ˜¯æŒ‡ï¼š

**A. ç®¡ç†åå°ï¼ˆim-adminï¼‰åº”è¯¥åªå…è®¸adminå’Œsuper_adminè®¿é—®ï¼Ÿ**
- éœ€è¦æ·»åŠ å‰ç«¯è§’è‰²æ£€æŸ¥
- æˆ–åˆ›å»ºAdminä¸­é—´ä»¶

**B. è¶…çº§ç®¡ç†å‘˜åº”è¯¥èƒ½æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„2FAå’Œè®¾å¤‡çŠ¶æ€ï¼Ÿ**
- éœ€è¦æ–°å¢ç®¡ç†å‘˜æŸ¥çœ‹API
- æ·»åŠ Adminä¸­é—´ä»¶

**C. å½“å‰é…ç½®å·²ç»æ­£ç¡®ï¼Ÿ**
- ç”¨æˆ·ç®¡ç†è‡ªå·±çš„2FAå’Œè®¾å¤‡ âœ…
- è¶…çº§ç®¡ç†å‘˜æœ‰ç³»ç»Ÿç®¡ç†æƒé™ âœ…
- æ— éœ€ä¿®æ”¹

è¯·å‘Šè¯‰æˆ‘æ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ç«‹å³å®ç°ï¼ğŸš€

