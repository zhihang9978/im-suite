# 🤖 机器人管理后台整合指南 v1.6.0

**功能**: 在超级管理员后台中管理聊天机器人

---

## 📍 访问位置

机器人管理功能已整合到 **系统管理** 页面中：

```
登录管理后台 → 左侧菜单 → 系统管理 → 切换到"机器人管理"标签
```

**路径**: `/system` → 选择标签页

---

## 📑 功能标签页

### 1. 🖥️ 系统信息（默认标签）
- 系统版本、运行时间
- CPU、内存、磁盘使用率
- 服务状态（数据库、Redis、MinIO等）
- 系统配置
- 系统操作

### 2. 🤖 机器人管理
- 创建和管理机器人
- 查看机器人统计
- 管理机器人权限
- 切换机器人状态
- 删除机器人

### 3. 👤 机器人用户
- 为机器人创建聊天账号
- 管理机器人的系统用户
- 删除机器人用户

### 4. 🔑 用户授权
- 授权用户使用机器人
- 查看授权列表
- 撤销用户权限
- 设置权限过期时间

---

## 🚀 完整使用流程

### 步骤1: 创建机器人（🤖 机器人管理标签）

1. 进入"系统管理"页面
2. 切换到"🤖 机器人管理"标签
3. 点击"➕ 创建机器人"按钮
4. 填写信息：
   - **名称**: 用户管理机器人
   - **描述**: 用于聊天界面中管理用户
   - **类型**: 内部机器人
   - **权限**: 勾选"创建用户"和"删除用户"
5. 点击"创建"
6. ⚠️ **立即保存API密钥**（只显示一次）

**结果**: 机器人创建成功，获得API Key和Secret

---

### 步骤2: 创建机器人用户（👤 机器人用户标签）

1. 切换到"👤 机器人用户"标签
2. 点击"➕ 创建机器人用户"按钮
3. 填写信息：
   - **选择机器人**: 用户管理机器人
   - **用户名**: userbot
   - **昵称**: 用户管理机器人
   - **头像URL**: (可选)
4. 点击"创建"

**结果**: 机器人现在有了聊天账号，用户可以搜索"userbot"找到它

---

### 步骤3: 授权用户（🔑 用户授权标签）

1. 切换到"🔑 用户授权"标签
2. 点击"➕ 授权用户"按钮
3. 填写信息：
   - **用户ID**: 10 （需要授权的用户ID）
   - **机器人**: 用户管理机器人
   - **过期时间**: (可选，留空表示永不过期)
4. 点击"授权"

**结果**: 用户ID=10的用户现在可以与机器人聊天

---

### 步骤4: 用户使用机器人（用户客户端）

用户在聊天应用中：

1. **搜索机器人**: 搜索"userbot"
2. **开始对话**: 发送消息
3. **使用命令**:

```
用户: /help
机器人: 🤖 命令帮助...

用户: /create phone=13800138001 username=test1 password=Pass123!
机器人: ✅ 用户创建成功！...

用户: /list
机器人: 📋 用户列表 (共 1 个)...

用户: /delete user_id=101 reason=测试完成
机器人: ✅ 用户删除成功！...
```

---

## 🎯 管理后台界面说明

### 🤖 机器人管理标签

**显示列表**:
| 列 | 说明 |
|---|---|
| 名称 | 机器人名称 |
| 类型 | internal/webhook/plugin |
| 描述 | 机器人功能说明 |
| 状态 | 激活/停用 |
| 统计 | 总计、成功、失败次数 |
| 操作 | 详情、启用/停用、删除 |

**操作按钮**:
- **详情**: 查看完整信息（权限、统计、API密钥信息等）
- **启用/停用**: 切换机器人状态
- **删除**: 永久删除机器人（不可恢复）

---

### 👤 机器人用户标签

**显示列表**:
| 列 | 说明 |
|---|---|
| 机器人 | 关联的机器人名称 |
| 用户名 | 在聊天中的用户名 |
| 昵称 | 显示的昵称 |
| 用户ID | 系统用户ID |
| 状态 | 激活/停用 |
| 创建时间 | 创建时间 |
| 操作 | 删除 |

**提示信息**:
```
💡 为机器人在系统中创建用户账号，使其可以在聊天界面中与用户交互。
```

**注意**:
- 一个机器人只能有一个用户账号
- 用户通过搜索"用户名"找到机器人
- 删除机器人用户后，机器人无法在聊天中使用

---

### 🔑 用户授权标签

**显示列表**:
| 列 | 说明 |
|---|---|
| 用户 | 被授权的用户名 |
| 机器人 | 可使用的机器人 |
| 授权者 | 授权管理员 |
| 授权时间 | 授权时间 |
| 过期时间 | 永不过期/具体时间/已过期 |
| 状态 | 激活/停用 |
| 操作 | 撤销 |

**颜色标识**:
- 🟢 绿色: 永不过期
- 🔵 蓝色: 未过期
- 🔴 红色: 已过期

---

## 🎨 界面截图说明

### 机器人管理标签
```
┌─────────────────────────────────────────────────┐
│ 🤖 机器人管理               [➕ 创建机器人]     │
├─────────────────────────────────────────────────┤
│ 名称           │ 类型   │ 状态 │ 统计      │ 操作│
├─────────────────────────────────────────────────┤
│ 用户管理机器人 │ internal│ ✅  │ 总:100   │ ... │
│                │         │      │ 成功:95  │     │
│                │         │      │ 失败:5   │     │
└─────────────────────────────────────────────────┘
```

### 机器人用户标签
```
┌─────────────────────────────────────────────────┐
│ 👤 机器人用户管理         [➕ 创建机器人用户]   │
├─────────────────────────────────────────────────┤
│ 💡 为机器人在系统中创建用户账号，使其可以在... │
├─────────────────────────────────────────────────┤
│ 机器人       │ 用户名  │ 昵称         │ 操作   │
├─────────────────────────────────────────────────┤
│用户管理机器人│ userbot │ 用户管理机器人│ [删除] │
└─────────────────────────────────────────────────┘
```

### 用户授权标签
```
┌─────────────────────────────────────────────────┐
│ 🔑 用户授权管理              [➕ 授权用户]      │
├─────────────────────────────────────────────────┤
│ 用户  │ 机器人       │ 授权者 │ 过期时间 │ 操作│
├─────────────────────────────────────────────────┤
│ user1 │用户管理机器人│ admin │ 永不过期 │[撤销]│
└─────────────────────────────────────────────────┘
```

---

## 🔄 操作流程图

```
超级管理员登录
    ↓
进入"系统管理"页面
    ↓
┌──────────────────────────────────┐
│  标签1: 系统信息                 │
│  标签2: 🤖 机器人管理            │ ← 创建机器人
│  标签3: 👤 机器人用户            │ ← 创建机器人用户
│  标签4: 🔑 用户授权              │ ← 授权普通用户
└──────────────────────────────────┘
    ↓
普通用户在聊天中
    ↓
搜索"userbot"并开始对话
    ↓
发送命令：/create, /delete, /list等
    ↓
机器人自动回复执行结果
```

---

## 💻 后台API调用示例

管理后台在幕后调用的API：

### 创建机器人
```javascript
// 前端代码
const createBot = async () => {
  const response = await axios.post('/api/super-admin/bots', {
    name: '用户管理机器人',
    description: '用于聊天界面中管理用户',
    type: 'internal',
    permissions: ['create_user', 'delete_user']
  })
  
  // 显示API密钥对话框
  createdApiKeys.value = {
    api_key: response.data.data.api_key,
    api_secret: response.data.data.api_secret
  }
  showApiKeysDialog.value = true
}
```

### 创建机器人用户
```javascript
const createBotUser = async () => {
  await axios.post('/api/super-admin/bot-users', {
    bot_id: 1,
    username: 'userbot',
    nickname: '用户管理机器人',
    avatar: ''
  })
  
  ElMessage.success('机器人用户创建成功！')
}
```

### 授权用户
```javascript
const grantPermission = async () => {
  await axios.post('/api/admin/bot-permissions', {
    user_id: 10,
    bot_id: 1,
    expires_at: null // 或具体时间
  })
  
  ElMessage.success('授权成功')
}
```

---

## 🎯 推荐的设置顺序

### 首次设置（超级管理员）

1. **系统管理** → **🤖 机器人管理** → 创建机器人
   - ✅ 获得API密钥（保存到安全位置）
   
2. **系统管理** → **👤 机器人用户** → 创建机器人用户
   - ✅ 机器人获得聊天账号
   
3. **系统管理** → **🔑 用户授权** → 授权用户
   - ✅ 指定用户可以使用机器人

### 日常管理

- 查看机器人调用统计
- 管理用户授权
- 查看操作日志
- 根据需要启用/停用机器人

---

## 🔐 权限说明

### 页面访问权限

| 标签页 | user | admin | super_admin |
|--------|------|-------|-------------|
| 系统信息 | ❌ | ❌ | ✅ |
| 机器人管理 | ❌ | ❌ | ✅ |
| 机器人用户 | ❌ | ❌ | ✅ |
| 用户授权 | ❌ | ✅ | ✅ |

**说明**:
- super_admin可以访问所有标签
- admin可以访问"用户授权"标签，授权/撤销用户权限
- 普通用户无法访问系统管理页面

---

## 📝 使用示例

### 示例1: 完整设置流程

```
1. 超级管理员打开"系统管理"
   
2. 切换到"🤖 机器人管理"标签
   - 点击"创建机器人"
   - 名称: "测试用户管理器"
   - 权限: create_user, delete_user
   - 获得API密钥并保存
   
3. 切换到"👤 机器人用户"标签
   - 点击"创建机器人用户"
   - 选择机器人: "测试用户管理器"
   - 用户名: "testbot"
   - 昵称: "测试机器人"
   
4. 切换到"🔑 用户授权"标签
   - 点击"授权用户"
   - 用户ID: 5
   - 机器人: "测试用户管理器"
   - 过期时间: 留空（永不过期）
   
5. 完成！用户ID=5的用户现在可以在聊天中搜索"testbot"并使用命令
```

### 示例2: 查看机器人统计

```
1. 进入"系统管理" → "🤖 机器人管理"
2. 找到要查看的机器人
3. 点击"详情"按钮
4. 查看：
   - 总调用次数
   - 成功/失败次数
   - 成功率
   - 最后使用时间
   - 权限列表
```

### 示例3: 管理用户授权

```
1. 进入"系统管理" → "🔑 用户授权"
2. 查看当前所有授权
3. 要撤销某个用户的权限：
   - 找到对应的授权记录
   - 点击"撤销"按钮
   - 确认操作
4. 要添加新授权：
   - 点击"授权用户"
   - 填写用户ID和机器人
   - 可选设置过期时间
```

---

## 🎨 界面特性

### 1. 标签式布局
- 使用Element Plus的Tabs组件
- 清晰分类不同功能
- 快速切换不同管理任务

### 2. 数据表格
- 使用Element Plus的Table组件
- 支持排序和筛选
- 响应式布局

### 3. 对话框操作
- 创建/编辑使用对话框
- 避免页面跳转
- 更流畅的用户体验

### 4. 实时反馈
- 操作成功/失败提示
- Loading状态显示
- 确认对话框防止误操作

---

## 🔧 技术实现

### 前端组件

**文件**: `im-admin/src/views/System.vue`

**技术栈**:
- Vue 3 Composition API
- Element Plus UI库
- Axios HTTP客户端

**主要功能**:
```javascript
// 机器人管理
- loadBots()           // 加载机器人列表
- createBot()          // 创建机器人
- toggleBotStatus()    // 切换状态
- deleteBot()          // 删除机器人
- viewBotDetails()     // 查看详情

// 机器人用户管理
- loadBotUsers()       // 加载机器人用户
- createBotUser()      // 创建机器人用户
- deleteBotUser()      // 删除机器人用户

// 权限管理
- loadPermissions()    // 加载权限列表
- grantPermission()    // 授权用户
- revokePermission()   // 撤销权限
```

---

## 📊 数据流

```
管理后台界面
    ↓ HTTP Request
后端API
    ↓ 数据库操作
MySQL数据库
    ↓ 读取/写入
5张表：
- bots
- bot_api_logs
- bot_users
- bot_user_permissions
- users
```

---

## 🎯 与API版本的对比

### API调用方式（v1.5.0）
```bash
# 需要编写代码或使用Postman
curl -X POST http://localhost:8080/api/bot/users \
  -H "X-Bot-Auth: Bot {key}:{secret}" \
  -d '{"phone":"...", "username":"..."}'
```

### 聊天界面方式（v1.6.0）
```
# 用户直接在聊天中输入
/create phone=13800138000 username=test password=Pass123!
```

### 管理后台方式（v1.6.0）
```
# 图形化界面，点击按钮操作
系统管理 → 🤖 机器人管理 → ➕ 创建机器人
```

**推荐使用**: 管理后台（最简单） + 聊天界面（最方便）

---

## ⚠️ 注意事项

### 1. API密钥安全
- ⚠️ API密钥只在创建时显示一次
- ⚠️ 务必立即复制并保存到安全位置
- ⚠️ 如果丢失，需要重新生成（旧密钥失效）

### 2. 机器人用户唯一性
- 一个机器人只能创建一个用户账号
- 用户名必须唯一
- 删除后可以重新创建

### 3. 权限管理
- 只有admin和super_admin可以授权用户
- 权限可以设置过期时间
- 撤销权限立即生效

### 4. 删除注意
- 删除机器人会删除其API调用日志
- 删除机器人用户会删除聊天账号
- 建议先停用再删除

---

## 🔜 未来计划

### v1.7.0
- 📋 批量授权用户
- 📋 权限模板
- 📋 授权审批流程
- 📋 更详细的统计图表

### v1.8.0
- 📋 机器人对话历史查看
- 📋 命令执行日志
- 📋 用户使用统计

---

## 📚 相关文档

- [机器人API文档](./api/bot-api-restricted.md)
- [聊天机器人使用指南](./BOT_CHAT_GUIDE.md)
- [机器人系统架构](./BOT_SYSTEM.md)

---

**最后更新**: 2024-12-19  
**版本**: v1.6.0  
**状态**: ✅ 已整合到系统管理页面

