# 🔧 志航密信 - 运维手册

## 📋 目录

1. [日常运维](#日常运维)
2. [监控告警](#监控告警)
3. [日志管理](#日志管理)
4. [备份与恢复](#备份与恢复)
5. [性能调优](#性能调优)
6. [故障排查](#故障排查)
7. [安全维护](#安全维护)
8. [扩容指南](#扩容指南)

---

## 日常运维

### 每日检查清单

```bash
# 1. 检查服务状态
docker-compose -f /opt/im-suite/docker-compose.production.yml ps

# 2. 检查系统资源
df -h                    # 磁盘空间
free -h                  # 内存使用
top                      # CPU使用

# 3. 检查日志
tail -f /var/log/im-suite/backend.log | grep ERROR

# 4. 检查备份
ls -lh /opt/im-suite/backups/ | tail -5

# 5. 检查Prometheus告警
curl http://localhost:9090/api/v1/alerts | jq '.data.alerts'
```

---

### 每周检查清单

```bash
# 1. 检查SSL证书过期时间
echo | openssl s_client -servername im.example.com -connect im.example.com:443 2>/dev/null | openssl x509 -noout -dates

# 2. 检查磁盘空间趋势
df -h

# 3. 清理旧日志
bash ops/cleanup-logs.sh

# 4. 检查Docker镜像
docker images | grep im-

# 5. 检查数据库大小
docker exec im-mysql-prod mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "SELECT table_schema, SUM(data_length + index_length) / 1024 / 1024 AS 'Size (MB)' FROM information_schema.tables GROUP BY table_schema;"
```

---

### 每月检查清单

```bash
# 1. 安全更新
sudo apt update && sudo apt upgrade -y

# 2. 密码轮换（建议90天）
# 更新.env中的密码，重启服务

# 3. 备份验证
bash ops/backup_restore.sh restore-test

# 4. 性能评估
bash ops/loadtest.sh

# 5. 依赖更新
cd im-backend && go get -u ./...
cd im-admin && npm update
```

---

## 监控告警

### Prometheus指标

**访问**: http://server-ip:9090

**关键指标**:

```promql
# API请求速率
rate(http_requests_total[5m])

# API响应时间P95
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# 错误率
rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])

# 活跃用户数
im_active_users_total

# 数据库连接池
mysql_connections_active

# Redis内存使用
redis_memory_used_bytes / redis_memory_max_bytes * 100

# WebRTC连接数
webrtc_connections_active

# 系统CPU
100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# 系统内存
(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100

# 网络带宽
rate(node_network_transmit_bytes_total[5m])
```

---

### Grafana面板

**访问**: http://server-ip:3000

**默认面板**:
- 系统监控面板
- API性能面板
- WebRTC监控面板
- 业务指标面板

**配置告警通知**:

1. **钉钉告警**:
```bash
# Grafana配置
通知渠道 -> 新增 -> DingDing
Webhook URL: https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN
```

2. **邮件告警**:
```bash
# 编辑Grafana配置
vim /etc/grafana/grafana.ini

[smtp]
enabled = true
host = smtp.example.com:587
user = alert@example.com
password = YOUR_PASSWORD
from_address = alert@example.com
```

---

### 告警处理流程

#### 1. CPU使用率过高 (>80%)

**告警**: `HighCPUUsage`

**处理步骤**:
```bash
# 1. 查看进程
top

# 2. 查看容器资源
docker stats

# 3. 检查慢查询
docker exec im-mysql-prod mysql -uroot -p -e "SHOW FULL PROCESSLIST;"

# 4. 如果持续过高，考虑扩容
```

---

#### 2. 内存使用率过高 (>85%)

**告警**: `HighMemoryUsage`

**处理步骤**:
```bash
# 1. 查看内存使用
free -h

# 2. 查看容器内存
docker stats

# 3. 清理Redis缓存（如果必要）
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} FLUSHDB

# 4. 重启服务释放内存
docker-compose -f /opt/im-suite/docker-compose.production.yml restart backend
```

---

#### 3. API错误率过高 (>1%)

**告警**: `HighErrorRate`

**处理步骤**:
```bash
# 1. 查看错误日志
docker logs im-backend-prod --tail=100 | grep ERROR

# 2. 检查数据库连接
docker exec im-mysql-prod mysql -uroot -p -e "SELECT 1;"

# 3. 检查Redis连接
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} PING

# 4. 如果是代码bug，立即回滚
bash ops/rollback.sh
```

---

#### 4. 数据库连接池耗尽

**告警**: `MySQLConnectionPoolExhausted`

**处理步骤**:
```bash
# 1. 查看活跃连接
docker exec im-mysql-prod mysql -uroot -p -e "SHOW PROCESSLIST;"

# 2. Kill慢查询
docker exec im-mysql-prod mysql -uroot -p -e "KILL <process_id>;"

# 3. 临时增加最大连接数
# 编辑 config/mysql/conf.d/custom.cnf
max_connections=200

# 4. 重启MySQL
docker-compose -f /opt/im-suite/docker-compose.production.yml restart mysql
```

---

#### 5. TURN中继失败率过高 (>10%)

**告警**: `TURNRelayFailureRate`

**处理步骤**:
```bash
# 1. 检查coturn状态
systemctl status coturn

# 2. 查看coturn日志
journalctl -u coturn -n 100

# 3. 检查端口
netstat -tulpn | grep -E "(3478|5349)"

# 4. 重启coturn
systemctl restart coturn

# 5. 检查防火墙
ufw status | grep -E "(49152:65535)"
```

---

## 日志管理

### 日志位置

```bash
# 后端日志
/var/log/im-suite/backend.log

# Nginx访问日志
/var/log/nginx/access.log

# Nginx错误日志
/var/log/nginx/error.log

# coturn日志
/var/log/turnserver.log

# Docker容器日志
docker logs im-backend-prod
docker logs im-mysql-prod
docker logs im-redis-prod
```

---

### 日志查询

```bash
# 查看最近100条错误
tail -100 /var/log/im-suite/backend.log | grep ERROR

# 实时查看日志
tail -f /var/log/im-suite/backend.log

# 搜索特定用户的操作
grep "user_id:12345" /var/log/im-suite/backend.log

# 统计API调用量
grep "POST /api/messages/send" /var/log/nginx/access.log | wc -l

# 查看慢查询（>1秒）
grep "duration" /var/log/im-suite/backend.log | awk -F'duration:' '{print $2}' | awk '{if ($1 > 1) print}'
```

---

### 日志归档

**自动归档** (logrotate):

配置文件: `/etc/logrotate.d/im-suite`

```bash
/var/log/im-suite/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 root root
    postrotate
        docker-compose -f /opt/im-suite/docker-compose.production.yml restart backend > /dev/null 2>&1 || true
    endscript
}
```

**手动归档**:

```bash
# 归档旧日志
tar -czf logs-$(date +%Y%m%d).tar.gz /var/log/im-suite/*.log

# 移动到归档目录
mv logs-*.tar.gz /opt/im-suite/backups/logs/

# 清理30天前的归档
find /opt/im-suite/backups/logs/ -name "logs-*.tar.gz" -mtime +30 -delete
```

---

## 备份与恢复

### 自动备份配置

**每日备份** (已在bootstrap.sh中配置):

```bash
# 查看crontab
crontab -l

# 应该包含:
0 2 * * * cd /opt/im-suite && bash ops/backup_restore.sh backup
```

---

### 手动备份

```bash
# 完整备份
bash ops/backup_restore.sh backup

# 仅备份数据库
docker exec im-mysql-prod mysqldump -uroot -p${MYSQL_ROOT_PASSWORD} --all-databases > backup-$(date +%Y%m%d).sql

# 仅备份Redis
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} SAVE
docker cp im-redis-prod:/data/dump.rdb ./redis-backup-$(date +%Y%m%d).rdb

# 仅备份MinIO
mc mirror local/im-files /opt/im-suite/backups/minio/$(date +%Y%m%d)/
```

---

### 恢复数据

```bash
# 恢复完整备份
bash ops/backup_restore.sh restore 20251011-150000

# 仅恢复数据库
cat backup-20251011.sql | docker exec -i im-mysql-prod mysql -uroot -p${MYSQL_ROOT_PASSWORD}

# 仅恢复Redis
docker cp redis-backup-20251011.rdb im-redis-prod:/data/dump.rdb
docker-compose restart redis
```

---

### 异地备份

**使用rclone备份到云存储**:

```bash
# 安装rclone
curl https://rclone.org/install.sh | sudo bash

# 配置云存储（如阿里云OSS）
rclone config

# 同步备份
rclone sync /opt/im-suite/backups/ aliyun:im-suite-backups/

# 配置自动同步
(crontab -l; echo "0 4 * * * rclone sync /opt/im-suite/backups/ aliyun:im-suite-backups/") | crontab -
```

---

## 性能调优

### MySQL优化

```sql
-- 查看慢查询
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;

-- 查看表大小
SELECT 
    table_name, 
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS "Size (MB)"
FROM information_schema.TABLES
WHERE table_schema = "im_suite"
ORDER BY (data_length + index_length) DESC;

-- 优化表
OPTIMIZE TABLE messages;

-- 分析查询
EXPLAIN SELECT * FROM messages WHERE user_id = 123 ORDER BY created_at DESC LIMIT 20;
```

---

### Redis优化

```bash
# 查看内存使用
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} INFO memory

# 查看慢查询
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} SLOWLOG GET 10

# 清理过期键
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} SCAN 0 MATCH "expired:*"

# 持久化策略
# 编辑 config/redis/redis.conf
save 900 1
save 300 10
save 60 10000
appendonly yes
```

---

### Nginx优化

```nginx
# 增加worker进程
worker_processes auto;
worker_connections 4096;

# 启用HTTP/2
listen 443 ssl http2;

# 增加缓冲区
client_body_buffer_size 128k;
client_max_body_size 100m;

# 启用Gzip
gzip on;
gzip_comp_level 6;
gzip_types text/plain text/css application/json application/javascript;

# 静态文件缓存
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

---

## 故障排查

### 常见故障处理

#### 故障1: 服务无法启动

```bash
# 查看容器状态
docker-compose -f /opt/im-suite/docker-compose.production.yml ps

# 查看启动日志
docker-compose -f /opt/im-suite/docker-compose.production.yml logs backend

# 检查端口占用
netstat -tulpn | grep -E "(8080|3306|6379)"

# 检查配置文件
docker-compose -f /opt/im-suite/docker-compose.production.yml config
```

---

#### 故障2: 数据库连接失败

```bash
# 1. 检查MySQL是否运行
docker ps | grep mysql

# 2. 测试连接
docker exec im-mysql-prod mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "SELECT 1;"

# 3. 检查网络
docker network ls
docker network inspect im-suite-network

# 4. 重启MySQL
docker-compose -f /opt/im-suite/docker-compose.production.yml restart mysql
```

---

#### 故障3: 前端无法访问

```bash
# 1. 检查Nginx状态
systemctl status nginx
nginx -t

# 2. 查看Nginx错误日志
tail -f /var/log/nginx/error.log

# 3. 检查防火墙
ufw status | grep -E "(80|443)"

# 4. 测试后端API
curl http://localhost:8080/health

# 5. 重启Nginx
systemctl restart nginx
```

---

#### 故障4: WebRTC连接失败

```bash
# 1. 检查TURN服务器
systemctl status coturn
netstat -tulpn | grep 3478

# 2. 测试TURN连接
turnutils_uclient -v -u turn_user -w password turn:im.example.com:3478

# 3. 检查防火墙UDP端口
ufw status | grep "49152:65535"

# 4. 查看coturn日志
tail -f /var/log/turnserver.log

# 5. 重启coturn
systemctl restart coturn
```

---

#### 故障5: 内存泄漏

```bash
# 1. 查看内存趋势
free -h
docker stats --no-stream

# 2. 查看进程内存
ps aux --sort=-%mem | head -20

# 3. 重启容器释放内存
docker-compose -f /opt/im-suite/docker-compose.production.yml restart backend

# 4. 如果是应用bug，更新代码并重新部署
git pull
bash ops/deploy.sh
```

---

## 安全维护

### 密码轮换

**建议周期**: 每90天

```bash
# 1. 生成新密码
NEW_JWT_SECRET=$(openssl rand -base64 48)
NEW_DB_PASSWORD=$(openssl rand -base64 32)

# 2. 更新.env文件
vim /opt/im-suite/.env

# 3. 更新数据库密码
docker exec im-mysql-prod mysql -uroot -p${OLD_PASSWORD} -e "ALTER USER 'im_user'@'%' IDENTIFIED BY '${NEW_DB_PASSWORD}';"

# 4. 重启服务
bash ops/deploy.sh
```

---

### 安全审计

**每月执行**:

```bash
# 1. 检查登录失败记录
grep "authentication failed" /var/log/im-suite/backend.log | tail -50

# 2. 检查异常IP访问
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -rn | head -20

# 3. 检查SQL注入尝试
grep -i "union\|select\|drop\|insert" /var/log/nginx/access.log

# 4. 扫描漏洞
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image im-backend-prod

# 5. 检查开放端口
nmap -sT -O localhost
```

---

### 防火墙管理

```bash
# 查看当前规则
ufw status numbered

# 添加IP白名单（管理后台）
ufw allow from 1.2.3.4 to any port 3001 comment "Admin IP"

# 删除规则
ufw delete <number>

# 封禁恶意IP
ufw deny from 5.6.7.8 comment "Malicious IP"

# 查看封禁列表
ufw status | grep DENY
```

---

## 扩容指南

### 垂直扩容

**增加单机资源**:

```bash
# 1. 修改Docker资源限制
vim docker-compose.production.yml

services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G

# 2. 重启服务
docker-compose -f /opt/im-suite/docker-compose.production.yml up -d
```

---

### 水平扩容

**增加后端实例**:

```bash
# 1. 配置负载均衡（Nginx）
upstream backend_cluster {
    least_conn;
    server backend-1:8080;
    server backend-2:8080;
    server backend-3:8080;
}

# 2. 启动多个实例
docker-compose -f /opt/im-suite/docker-compose.production.yml up -d --scale backend=3

# 3. 验证负载均衡
for i in {1..10}; do curl http://localhost/api/health; done
```

---

## 联系支持

- **紧急故障**: 拨打运维热线
- **GitHub Issues**: https://github.com/zhihang9978/im-suite/issues
- **文档**: https://github.com/zhihang9978/im-suite/docs

---

**更新时间**: 2025-10-11  
**版本**: v1.0.0  
**维护者**: zhihang9978

