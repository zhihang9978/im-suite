# ğŸ”§ å¿—èˆªå¯†ä¿¡ - è¿ç»´æ‰‹å†Œ

## ğŸ“‹ ç›®å½•

1. [æ—¥å¸¸è¿ç»´](#æ—¥å¸¸è¿ç»´)
2. [ç›‘æ§å‘Šè­¦](#ç›‘æ§å‘Šè­¦)
3. [æ—¥å¿—ç®¡ç†](#æ—¥å¿—ç®¡ç†)
4. [å¤‡ä»½ä¸æ¢å¤](#å¤‡ä»½ä¸æ¢å¤)
5. [æ€§èƒ½è°ƒä¼˜](#æ€§èƒ½è°ƒä¼˜)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
7. [å®‰å…¨ç»´æŠ¤](#å®‰å…¨ç»´æŠ¤)
8. [æ‰©å®¹æŒ‡å—](#æ‰©å®¹æŒ‡å—)

---

## æ—¥å¸¸è¿ç»´

### æ¯æ—¥æ£€æŸ¥æ¸…å•

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f /opt/im-suite/docker-compose.production.yml ps

# 2. æ£€æŸ¥ç³»ç»Ÿèµ„æº
df -h                    # ç£ç›˜ç©ºé—´
free -h                  # å†…å­˜ä½¿ç”¨
top                      # CPUä½¿ç”¨

# 3. æ£€æŸ¥æ—¥å¿—
tail -f /var/log/im-suite/backend.log | grep ERROR

# 4. æ£€æŸ¥å¤‡ä»½
ls -lh /opt/im-suite/backups/ | tail -5

# 5. æ£€æŸ¥Prometheuså‘Šè­¦
curl http://localhost:9090/api/v1/alerts | jq '.data.alerts'
```

---

### æ¯å‘¨æ£€æŸ¥æ¸…å•

```bash
# 1. æ£€æŸ¥SSLè¯ä¹¦è¿‡æœŸæ—¶é—´
echo | openssl s_client -servername im.example.com -connect im.example.com:443 2>/dev/null | openssl x509 -noout -dates

# 2. æ£€æŸ¥ç£ç›˜ç©ºé—´è¶‹åŠ¿
df -h

# 3. æ¸…ç†æ—§æ—¥å¿—
bash ops/cleanup-logs.sh

# 4. æ£€æŸ¥Dockeré•œåƒ
docker images | grep im-

# 5. æ£€æŸ¥æ•°æ®åº“å¤§å°
docker exec im-mysql-prod mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "SELECT table_schema, SUM(data_length + index_length) / 1024 / 1024 AS 'Size (MB)' FROM information_schema.tables GROUP BY table_schema;"
```

---

### æ¯æœˆæ£€æŸ¥æ¸…å•

```bash
# 1. å®‰å…¨æ›´æ–°
sudo apt update && sudo apt upgrade -y

# 2. å¯†ç è½®æ¢ï¼ˆå»ºè®®90å¤©ï¼‰
# æ›´æ–°.envä¸­çš„å¯†ç ï¼Œé‡å¯æœåŠ¡

# 3. å¤‡ä»½éªŒè¯
bash ops/backup_restore.sh restore-test

# 4. æ€§èƒ½è¯„ä¼°
bash ops/loadtest.sh

# 5. ä¾èµ–æ›´æ–°
cd im-backend && go get -u ./...
cd im-admin && npm update
```

---

## ç›‘æ§å‘Šè­¦

### PrometheusæŒ‡æ ‡

**è®¿é—®**: http://server-ip:9090

**å…³é”®æŒ‡æ ‡**:

```promql
# APIè¯·æ±‚é€Ÿç‡
rate(http_requests_total[5m])

# APIå“åº”æ—¶é—´P95
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# é”™è¯¯ç‡
rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])

# æ´»è·ƒç”¨æˆ·æ•°
im_active_users_total

# æ•°æ®åº“è¿æ¥æ± 
mysql_connections_active

# Rediså†…å­˜ä½¿ç”¨
redis_memory_used_bytes / redis_memory_max_bytes * 100

# WebRTCè¿æ¥æ•°
webrtc_connections_active

# ç³»ç»ŸCPU
100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# ç³»ç»Ÿå†…å­˜
(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100

# ç½‘ç»œå¸¦å®½
rate(node_network_transmit_bytes_total[5m])
```

---

### Grafanaé¢æ¿

**è®¿é—®**: http://server-ip:3000

**é»˜è®¤é¢æ¿**:
- ç³»ç»Ÿç›‘æ§é¢æ¿
- APIæ€§èƒ½é¢æ¿
- WebRTCç›‘æ§é¢æ¿
- ä¸šåŠ¡æŒ‡æ ‡é¢æ¿

**é…ç½®å‘Šè­¦é€šçŸ¥**:

1. **é’‰é’‰å‘Šè­¦**:
```bash
# Grafanaé…ç½®
é€šçŸ¥æ¸ é“ -> æ–°å¢ -> DingDing
Webhook URL: https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN
```

2. **é‚®ä»¶å‘Šè­¦**:
```bash
# ç¼–è¾‘Grafanaé…ç½®
vim /etc/grafana/grafana.ini

[smtp]
enabled = true
host = smtp.example.com:587
user = alert@example.com
password = YOUR_PASSWORD
from_address = alert@example.com
```

---

### å‘Šè­¦å¤„ç†æµç¨‹

#### 1. CPUä½¿ç”¨ç‡è¿‡é«˜ (>80%)

**å‘Šè­¦**: `HighCPUUsage`

**å¤„ç†æ­¥éª¤**:
```bash
# 1. æŸ¥çœ‹è¿›ç¨‹
top

# 2. æŸ¥çœ‹å®¹å™¨èµ„æº
docker stats

# 3. æ£€æŸ¥æ…¢æŸ¥è¯¢
docker exec im-mysql-prod mysql -uroot -p -e "SHOW FULL PROCESSLIST;"

# 4. å¦‚æœæŒç»­è¿‡é«˜ï¼Œè€ƒè™‘æ‰©å®¹
```

---

#### 2. å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ (>85%)

**å‘Šè­¦**: `HighMemoryUsage`

**å¤„ç†æ­¥éª¤**:
```bash
# 1. æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# 2. æŸ¥çœ‹å®¹å™¨å†…å­˜
docker stats

# 3. æ¸…ç†Redisç¼“å­˜ï¼ˆå¦‚æœå¿…è¦ï¼‰
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} FLUSHDB

# 4. é‡å¯æœåŠ¡é‡Šæ”¾å†…å­˜
docker-compose -f /opt/im-suite/docker-compose.production.yml restart backend
```

---

#### 3. APIé”™è¯¯ç‡è¿‡é«˜ (>1%)

**å‘Šè­¦**: `HighErrorRate`

**å¤„ç†æ­¥éª¤**:
```bash
# 1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker logs im-backend-prod --tail=100 | grep ERROR

# 2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker exec im-mysql-prod mysql -uroot -p -e "SELECT 1;"

# 3. æ£€æŸ¥Redisè¿æ¥
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} PING

# 4. å¦‚æœæ˜¯ä»£ç bugï¼Œç«‹å³å›æ»š
bash ops/rollback.sh
```

---

#### 4. æ•°æ®åº“è¿æ¥æ± è€—å°½

**å‘Šè­¦**: `MySQLConnectionPoolExhausted`

**å¤„ç†æ­¥éª¤**:
```bash
# 1. æŸ¥çœ‹æ´»è·ƒè¿æ¥
docker exec im-mysql-prod mysql -uroot -p -e "SHOW PROCESSLIST;"

# 2. Killæ…¢æŸ¥è¯¢
docker exec im-mysql-prod mysql -uroot -p -e "KILL <process_id>;"

# 3. ä¸´æ—¶å¢åŠ æœ€å¤§è¿æ¥æ•°
# ç¼–è¾‘ config/mysql/conf.d/custom.cnf
max_connections=200

# 4. é‡å¯MySQL
docker-compose -f /opt/im-suite/docker-compose.production.yml restart mysql
```

---

#### 5. TURNä¸­ç»§å¤±è´¥ç‡è¿‡é«˜ (>10%)

**å‘Šè­¦**: `TURNRelayFailureRate`

**å¤„ç†æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥coturnçŠ¶æ€
systemctl status coturn

# 2. æŸ¥çœ‹coturnæ—¥å¿—
journalctl -u coturn -n 100

# 3. æ£€æŸ¥ç«¯å£
netstat -tulpn | grep -E "(3478|5349)"

# 4. é‡å¯coturn
systemctl restart coturn

# 5. æ£€æŸ¥é˜²ç«å¢™
ufw status | grep -E "(49152:65535)"
```

---

## æ—¥å¿—ç®¡ç†

### æ—¥å¿—ä½ç½®

```bash
# åç«¯æ—¥å¿—
/var/log/im-suite/backend.log

# Nginxè®¿é—®æ—¥å¿—
/var/log/nginx/access.log

# Nginxé”™è¯¯æ—¥å¿—
/var/log/nginx/error.log

# coturnæ—¥å¿—
/var/log/turnserver.log

# Dockerå®¹å™¨æ—¥å¿—
docker logs im-backend-prod
docker logs im-mysql-prod
docker logs im-redis-prod
```

---

### æ—¥å¿—æŸ¥è¯¢

```bash
# æŸ¥çœ‹æœ€è¿‘100æ¡é”™è¯¯
tail -100 /var/log/im-suite/backend.log | grep ERROR

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/im-suite/backend.log

# æœç´¢ç‰¹å®šç”¨æˆ·çš„æ“ä½œ
grep "user_id:12345" /var/log/im-suite/backend.log

# ç»Ÿè®¡APIè°ƒç”¨é‡
grep "POST /api/messages/send" /var/log/nginx/access.log | wc -l

# æŸ¥çœ‹æ…¢æŸ¥è¯¢ï¼ˆ>1ç§’ï¼‰
grep "duration" /var/log/im-suite/backend.log | awk -F'duration:' '{print $2}' | awk '{if ($1 > 1) print}'
```

---

### æ—¥å¿—å½’æ¡£

**è‡ªåŠ¨å½’æ¡£** (logrotate):

é…ç½®æ–‡ä»¶: `/etc/logrotate.d/im-suite`

```bash
/var/log/im-suite/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 root root
    postrotate
        docker-compose -f /opt/im-suite/docker-compose.production.yml restart backend > /dev/null 2>&1 || true
    endscript
}
```

**æ‰‹åŠ¨å½’æ¡£**:

```bash
# å½’æ¡£æ—§æ—¥å¿—
tar -czf logs-$(date +%Y%m%d).tar.gz /var/log/im-suite/*.log

# ç§»åŠ¨åˆ°å½’æ¡£ç›®å½•
mv logs-*.tar.gz /opt/im-suite/backups/logs/

# æ¸…ç†30å¤©å‰çš„å½’æ¡£
find /opt/im-suite/backups/logs/ -name "logs-*.tar.gz" -mtime +30 -delete
```

---

## å¤‡ä»½ä¸æ¢å¤

### è‡ªåŠ¨å¤‡ä»½é…ç½®

**æ¯æ—¥å¤‡ä»½** (å·²åœ¨bootstrap.shä¸­é…ç½®):

```bash
# æŸ¥çœ‹crontab
crontab -l

# åº”è¯¥åŒ…å«:
0 2 * * * cd /opt/im-suite && bash ops/backup_restore.sh backup
```

---

### æ‰‹åŠ¨å¤‡ä»½

```bash
# å®Œæ•´å¤‡ä»½
bash ops/backup_restore.sh backup

# ä»…å¤‡ä»½æ•°æ®åº“
docker exec im-mysql-prod mysqldump -uroot -p${MYSQL_ROOT_PASSWORD} --all-databases > backup-$(date +%Y%m%d).sql

# ä»…å¤‡ä»½Redis
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} SAVE
docker cp im-redis-prod:/data/dump.rdb ./redis-backup-$(date +%Y%m%d).rdb

# ä»…å¤‡ä»½MinIO
mc mirror local/im-files /opt/im-suite/backups/minio/$(date +%Y%m%d)/
```

---

### æ¢å¤æ•°æ®

```bash
# æ¢å¤å®Œæ•´å¤‡ä»½
bash ops/backup_restore.sh restore 20251011-150000

# ä»…æ¢å¤æ•°æ®åº“
cat backup-20251011.sql | docker exec -i im-mysql-prod mysql -uroot -p${MYSQL_ROOT_PASSWORD}

# ä»…æ¢å¤Redis
docker cp redis-backup-20251011.rdb im-redis-prod:/data/dump.rdb
docker-compose restart redis
```

---

### å¼‚åœ°å¤‡ä»½

**ä½¿ç”¨rcloneå¤‡ä»½åˆ°äº‘å­˜å‚¨**:

```bash
# å®‰è£…rclone
curl https://rclone.org/install.sh | sudo bash

# é…ç½®äº‘å­˜å‚¨ï¼ˆå¦‚é˜¿é‡Œäº‘OSSï¼‰
rclone config

# åŒæ­¥å¤‡ä»½
rclone sync /opt/im-suite/backups/ aliyun:im-suite-backups/

# é…ç½®è‡ªåŠ¨åŒæ­¥
(crontab -l; echo "0 4 * * * rclone sync /opt/im-suite/backups/ aliyun:im-suite-backups/") | crontab -
```

---

## æ€§èƒ½è°ƒä¼˜

### MySQLä¼˜åŒ–

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT 
    table_name, 
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS "Size (MB)"
FROM information_schema.TABLES
WHERE table_schema = "im_suite"
ORDER BY (data_length + index_length) DESC;

-- ä¼˜åŒ–è¡¨
OPTIMIZE TABLE messages;

-- åˆ†ææŸ¥è¯¢
EXPLAIN SELECT * FROM messages WHERE user_id = 123 ORDER BY created_at DESC LIMIT 20;
```

---

### Redisä¼˜åŒ–

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} INFO memory

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} SLOWLOG GET 10

# æ¸…ç†è¿‡æœŸé”®
docker exec im-redis-prod redis-cli --no-auth-warning -a ${REDIS_PASSWORD} SCAN 0 MATCH "expired:*"

# æŒä¹…åŒ–ç­–ç•¥
# ç¼–è¾‘ config/redis/redis.conf
save 900 1
save 300 10
save 60 10000
appendonly yes
```

---

### Nginxä¼˜åŒ–

```nginx
# å¢åŠ workerè¿›ç¨‹
worker_processes auto;
worker_connections 4096;

# å¯ç”¨HTTP/2
listen 443 ssl http2;

# å¢åŠ ç¼“å†²åŒº
client_body_buffer_size 128k;
client_max_body_size 100m;

# å¯ç”¨Gzip
gzip on;
gzip_comp_level 6;
gzip_types text/plain text/css application/json application/javascript;

# é™æ€æ–‡ä»¶ç¼“å­˜
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§æ•…éšœå¤„ç†

#### æ•…éšœ1: æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose -f /opt/im-suite/docker-compose.production.yml ps

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker-compose -f /opt/im-suite/docker-compose.production.yml logs backend

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep -E "(8080|3306|6379)"

# æ£€æŸ¥é…ç½®æ–‡ä»¶
docker-compose -f /opt/im-suite/docker-compose.production.yml config
```

---

#### æ•…éšœ2: æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# 1. æ£€æŸ¥MySQLæ˜¯å¦è¿è¡Œ
docker ps | grep mysql

# 2. æµ‹è¯•è¿æ¥
docker exec im-mysql-prod mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "SELECT 1;"

# 3. æ£€æŸ¥ç½‘ç»œ
docker network ls
docker network inspect im-suite-network

# 4. é‡å¯MySQL
docker-compose -f /opt/im-suite/docker-compose.production.yml restart mysql
```

---

#### æ•…éšœ3: å‰ç«¯æ— æ³•è®¿é—®

```bash
# 1. æ£€æŸ¥NginxçŠ¶æ€
systemctl status nginx
nginx -t

# 2. æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log

# 3. æ£€æŸ¥é˜²ç«å¢™
ufw status | grep -E "(80|443)"

# 4. æµ‹è¯•åç«¯API
curl http://localhost:8080/health

# 5. é‡å¯Nginx
systemctl restart nginx
```

---

#### æ•…éšœ4: WebRTCè¿æ¥å¤±è´¥

```bash
# 1. æ£€æŸ¥TURNæœåŠ¡å™¨
systemctl status coturn
netstat -tulpn | grep 3478

# 2. æµ‹è¯•TURNè¿æ¥
turnutils_uclient -v -u turn_user -w password turn:im.example.com:3478

# 3. æ£€æŸ¥é˜²ç«å¢™UDPç«¯å£
ufw status | grep "49152:65535"

# 4. æŸ¥çœ‹coturnæ—¥å¿—
tail -f /var/log/turnserver.log

# 5. é‡å¯coturn
systemctl restart coturn
```

---

#### æ•…éšœ5: å†…å­˜æ³„æ¼

```bash
# 1. æŸ¥çœ‹å†…å­˜è¶‹åŠ¿
free -h
docker stats --no-stream

# 2. æŸ¥çœ‹è¿›ç¨‹å†…å­˜
ps aux --sort=-%mem | head -20

# 3. é‡å¯å®¹å™¨é‡Šæ”¾å†…å­˜
docker-compose -f /opt/im-suite/docker-compose.production.yml restart backend

# 4. å¦‚æœæ˜¯åº”ç”¨bugï¼Œæ›´æ–°ä»£ç å¹¶é‡æ–°éƒ¨ç½²
git pull
bash ops/deploy.sh
```

---

## å®‰å…¨ç»´æŠ¤

### å¯†ç è½®æ¢

**å»ºè®®å‘¨æœŸ**: æ¯90å¤©

```bash
# 1. ç”Ÿæˆæ–°å¯†ç 
NEW_JWT_SECRET=$(openssl rand -base64 48)
NEW_DB_PASSWORD=$(openssl rand -base64 32)

# 2. æ›´æ–°.envæ–‡ä»¶
vim /opt/im-suite/.env

# 3. æ›´æ–°æ•°æ®åº“å¯†ç 
docker exec im-mysql-prod mysql -uroot -p${OLD_PASSWORD} -e "ALTER USER 'im_user'@'%' IDENTIFIED BY '${NEW_DB_PASSWORD}';"

# 4. é‡å¯æœåŠ¡
bash ops/deploy.sh
```

---

### å®‰å…¨å®¡è®¡

**æ¯æœˆæ‰§è¡Œ**:

```bash
# 1. æ£€æŸ¥ç™»å½•å¤±è´¥è®°å½•
grep "authentication failed" /var/log/im-suite/backend.log | tail -50

# 2. æ£€æŸ¥å¼‚å¸¸IPè®¿é—®
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -rn | head -20

# 3. æ£€æŸ¥SQLæ³¨å…¥å°è¯•
grep -i "union\|select\|drop\|insert" /var/log/nginx/access.log

# 4. æ‰«ææ¼æ´
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image im-backend-prod

# 5. æ£€æŸ¥å¼€æ”¾ç«¯å£
nmap -sT -O localhost
```

---

### é˜²ç«å¢™ç®¡ç†

```bash
# æŸ¥çœ‹å½“å‰è§„åˆ™
ufw status numbered

# æ·»åŠ IPç™½åå•ï¼ˆç®¡ç†åå°ï¼‰
ufw allow from 1.2.3.4 to any port 3001 comment "Admin IP"

# åˆ é™¤è§„åˆ™
ufw delete <number>

# å°ç¦æ¶æ„IP
ufw deny from 5.6.7.8 comment "Malicious IP"

# æŸ¥çœ‹å°ç¦åˆ—è¡¨
ufw status | grep DENY
```

---

## æ‰©å®¹æŒ‡å—

### å‚ç›´æ‰©å®¹

**å¢åŠ å•æœºèµ„æº**:

```bash
# 1. ä¿®æ”¹Dockerèµ„æºé™åˆ¶
vim docker-compose.production.yml

services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G

# 2. é‡å¯æœåŠ¡
docker-compose -f /opt/im-suite/docker-compose.production.yml up -d
```

---

### æ°´å¹³æ‰©å®¹

**å¢åŠ åç«¯å®ä¾‹**:

```bash
# 1. é…ç½®è´Ÿè½½å‡è¡¡ï¼ˆNginxï¼‰
upstream backend_cluster {
    least_conn;
    server backend-1:8080;
    server backend-2:8080;
    server backend-3:8080;
}

# 2. å¯åŠ¨å¤šä¸ªå®ä¾‹
docker-compose -f /opt/im-suite/docker-compose.production.yml up -d --scale backend=3

# 3. éªŒè¯è´Ÿè½½å‡è¡¡
for i in {1..10}; do curl http://localhost/api/health; done
```

---

## è”ç³»æ”¯æŒ

- **ç´§æ€¥æ•…éšœ**: æ‹¨æ‰“è¿ç»´çƒ­çº¿
- **GitHub Issues**: https://github.com/zhihang9978/im-suite/issues
- **æ–‡æ¡£**: https://github.com/zhihang9978/im-suite/docs

---

**æ›´æ–°æ—¶é—´**: 2025-10-11  
**ç‰ˆæœ¬**: v1.0.0  
**ç»´æŠ¤è€…**: zhihang9978

