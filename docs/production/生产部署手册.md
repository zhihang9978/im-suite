# 🚀 志航密信 - 生产部署手册

## 📋 目录

1. [部署前准备](#部署前准备)
2. [服务器配置](#服务器配置)
3. [部署步骤](#部署步骤)
4. [TURN/SFU配置](#turnsfu配置)
5. [HTTPS配置](#https配置)
6. [监控配置](#监控配置)
7. [验证部署](#验证部署)
8. [常见问题](#常见问题)

---

## 部署前准备

### 硬件要求

**最低配置（支持100并发用户）**:
- CPU: 4核心
- 内存: 8GB
- 磁盘: 100GB SSD
- 带宽: 100Mbps

**推荐配置（支持300+并发用户）**:
- CPU: 8核心+
- 内存: 16GB+
- 磁盘: 500GB SSD
- 带宽: 1Gbps
- 多公网IP（WebRTC优化）

### 软件要求

- 操作系统: Ubuntu 20.04/22.04 或 CentOS 7/8
- Docker: 20.10+
- Docker Compose: 2.0+
- Git: 2.x+
- Nginx: 1.18+

### 域名和证书

- 准备域名（如：`im.example.com`）
- DNS解析已配置
- 准备SSL证书（Let's Encrypt或商业证书）

### 网络要求

- 开放端口：
  - 22 (SSH)
  - 80 (HTTP)
  - 443 (HTTPS)
  - 3478 (TURN TCP/UDP)
  - 5349 (TURN TLS)
  - 49152-65535 (WebRTC UDP)

---

## 服务器配置

### 1. 系统初始化

```bash
# 以root用户登录服务器

# 克隆项目
cd /opt
git clone https://github.com/zhihang9978/im-suite.git
cd im-suite

# 执行系统初始化脚本
sudo bash ops/bootstrap.sh
```

**此脚本将：**
- ✅ 安装系统依赖
- ✅ 安装Docker和Docker Compose
- ✅ 优化内核参数（BBR、文件描述符等）
- ✅ 配置防火墙规则
- ✅ 配置日志轮转
- ✅ 安装coturn（TURN服务器）
- ✅ 创建系统服务

**预计时间**: 5-10分钟

---

### 2. 配置环境变量

```bash
# 复制环境变量模板
cp ENV_EXAMPLE.md .env

# 编辑配置文件
vim .env
```

**必须配置的关键变量**:

```bash
# 应用配置
APP_BASE_URL=https://im.example.com

# 数据库密码（使用强密码）
MYSQL_ROOT_PASSWORD=$(openssl rand -base64 32)
MYSQL_PASSWORD=$(openssl rand -base64 32)

# Redis密码
REDIS_PASSWORD=$(openssl rand -base64 32)

# MinIO密码
MINIO_ROOT_PASSWORD=$(openssl rand -base64 32)

# JWT密钥（48字符以上）
JWT_SECRET=$(openssl rand -base64 48)

# 加密密钥
ENCRYPTION_KEY=$(openssl rand -base64 32)

# 管理员信息
ADMIN_EMAIL=admin@example.com
ADMIN_PHONE=13800138000
ADMIN_PASSWORD=YourStrongPassword123!

# TURN配置
TURN_SERVER=turn:im.example.com:3478
TURN_USERNAME=turn_user
TURN_PASSWORD=$(openssl rand -base64 24)
TURN_REALM=example.com
TURN_PUBLIC_IPS=1.2.3.4,5.6.7.8  # 您的公网IP

# CORS配置
CORS_ALLOWED_ORIGINS=https://im.example.com,https://www.example.com

# 安全配置
DEBUG=false
SWAGGER_ENABLED=false
RATE_LIMIT_ENABLED=true

# 监控配置
METRICS_ENABLED=true
SENTRY_ENABLED=false  # 可选
```

**验证配置**:

```bash
# 检查必需变量
bash ops/validate-env.sh
```

---

## 部署步骤

### 方法1：一键部署（推荐）

```bash
cd /opt/im-suite

# 执行部署脚本
sudo bash ops/deploy.sh
```

**部署流程**:
1. ✅ 前置检查（环境变量、依赖）
2. ✅ 备份当前版本（如果存在）
3. ✅ 拉取最新代码
4. ✅ 构建Docker镜像
5. ✅ 执行数据库迁移
6. ✅ 零停机部署（蓝绿切换）
7. ✅ 健康检查
8. ✅ 清理旧镜像

**预计时间**: 5-15分钟（首次部署）

---

### 方法2：手动部署

```bash
cd /opt/im-suite

# 1. 构建镜像
docker-compose -f docker-compose.production.yml build

# 2. 启动服务
docker-compose -f docker-compose.production.yml up -d

# 3. 查看日志
docker-compose -f docker-compose.production.yml logs -f

# 4. 检查服务状态
docker-compose -f docker-compose.production.yml ps
```

---

## TURN/SFU配置

### 配置TURN服务器

```bash
# 执行TURN配置脚本
sudo bash ops/setup-turn.sh
```

**交互式配置**:
- 输入域名: `im.example.com`
- 输入公网IP: `1.2.3.4,5.6.7.8`（逗号分隔）
- 输入用户名: `turn_user`
- 输入密码: （自动生成或手动输入）

**验证TURN**:

在线测试: https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/

配置参数:
```
STUN/TURN URI: turn:im.example.com:3478
Username: turn_user
Password: （您设置的密码）
```

**预期结果**: 应该看到 `relay` 类型的候选项

---

### 配置SFU（可选，用于多方通话）

```bash
# 使用Docker Compose部署ion-sfu
docker-compose -f docker-compose.sfu.yml up -d
```

**ion-sfu配置** (`config/webrtc/sfu.yaml`):
```yaml
sfu:
  ballast: 20MiB
  withstats: true

webrtc:
  iceportrange: [5000, 5200]
  icelite: true
  candidates:
    - network: udp
      ip: 1.2.3.4  # 您的公网IP
      port: 5000
      portmax: 5200
```

---

## HTTPS配置

### 方法1：使用Let's Encrypt（推荐）

```bash
# 执行SSL配置脚本
sudo bash ops/setup-ssl.sh
```

**选择**: 1 (Let's Encrypt)

**交互式配置**:
- 域名: `im.example.com`
- 邮箱: `admin@example.com`

**自动完成**:
- ✅ 申请SSL证书
- ✅ 配置Nginx HTTPS
- ✅ HTTP自动跳转HTTPS
- ✅ 配置安全头（HSTS、CSP等）
- ✅ 配置自动续期（每天凌晨3点）

---

### 方法2：手动配置（已有证书）

```bash
# 1. 上传证书文件
scp your-cert.crt root@server:/opt/im-suite/ssl/
scp your-key.key root@server:/opt/im-suite/ssl/

# 2. 执行配置脚本并选择"导入证书"
sudo bash ops/setup-ssl.sh
# 选择: 3 (导入证书)
```

---

### 验证HTTPS

```bash
# 本地测试
curl -I https://im.example.com

# SSL评分测试
# 访问: https://www.ssllabs.com/ssltest/
# 目标评分: A+ 或 A
```

---

## 监控配置

### 启动监控服务

```bash
# 启动Prometheus和Grafana
docker-compose -f docker-compose.monitoring.yml up -d
```

**访问地址**:
- Prometheus: http://server-ip:9090
- Grafana: http://server-ip:3000

**Grafana配置**:

1. **登录**:
   - 用户名: `admin`
   - 密码: `admin`（首次登录后修改）

2. **添加数据源**:
   - 类型: Prometheus
   - URL: `http://prometheus:9090`

3. **导入面板**:
   - 上传 `config/grafana/dashboards/im-suite-dashboard.json`

4. **配置告警**:
   - 添加告警渠道（Email/钉钉/企业微信）
   - 配置告警规则

---

## 验证部署

### 1. 健康检查

```bash
# 后端健康检查
curl http://localhost:8080/health

# 预期响应
{
  "status": "healthy",
  "timestamp": "2025-10-11T16:00:00Z"
}
```

### 2. 服务状态

```bash
# 查看所有服务状态
docker-compose -f docker-compose.production.yml ps

# 预期：所有服务状态为 "Up (healthy)"
```

### 3. 日志检查

```bash
# 查看后端日志
docker logs im-backend-prod --tail=100

# 查看Nginx日志
tail -f /var/log/nginx/access.log
```

### 4. 性能测试

```bash
# 运行压力测试
bash ops/loadtest.sh

# 检查结果
cat loadtest-reports/report-*.json
```

**目标SLO**:
- ✅ 登录API P95 < 200ms
- ✅ 并发300用户，错误率 < 0.1%
- ✅ WebRTC 20路720p并发

---

### 5. 端到端测试

```bash
# 运行E2E测试
bash ops/e2e-test.sh

# 预期：所有测试通过
```

**测试流程**:
1. ✅ 用户注册
2. ✅ 用户登录
3. ✅ 发送文本消息
4. ✅ 发送图片
5. ✅ 语音通话
6. ✅ 视频通话

---

## 备份配置

### 配置自动备份

```bash
# 配置每日自动备份（凌晨2点）
(crontab -l 2>/dev/null; echo "0 2 * * * cd /opt/im-suite && bash ops/backup_restore.sh backup") | crontab -
```

### 手动备份

```bash
# 立即执行备份
bash ops/backup_restore.sh backup

# 查看备份
ls -lh /opt/im-suite/backups/
```

---

## 常见问题

### Q1: 部署失败，健康检查超时

**解决方案**:
```bash
# 查看容器日志
docker logs im-backend-prod --tail=100

# 常见原因：
# 1. 数据库连接失败 -> 检查MYSQL_PASSWORD
# 2. Redis连接失败 -> 检查REDIS_PASSWORD
# 3. 端口被占用 -> netstat -tulpn | grep 8080
```

---

### Q2: 前端无法访问后端API（CORS错误）

**解决方案**:
```bash
# 检查CORS配置
grep CORS_ALLOWED_ORIGINS .env

# 必须包含前端域名
CORS_ALLOWED_ORIGINS=https://im.example.com
```

---

### Q3: WebRTC连接失败

**解决方案**:
```bash
# 1. 检查TURN服务器状态
systemctl status coturn

# 2. 检查防火墙
ufw status | grep -E "(3478|5349|49152)"

# 3. 测试TURN连接
# 访问: https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/
```

---

### Q4: SSL证书续期失败

**解决方案**:
```bash
# 手动续期
certbot renew --dry-run  # 测试
certbot renew            # 实际续期

# 重启Nginx
systemctl reload nginx
```

---

### Q5: 数据库迁移失败

**解决方案**:
```bash
# 1. 检查数据库连接
docker exec -it im-mysql-prod mysql -uroot -p

# 2. 手动运行迁移
docker exec -it im-backend-prod go run main.go migrate

# 3. 如果仍然失败，查看日志
docker logs im-backend-prod | grep "migration"
```

---

## 回滚操作

### 快速回滚

```bash
# 查看可用的备份版本
ls -lt /opt/im-suite/backups/deployments/

# 回滚到指定版本
bash ops/rollback.sh 20251011-150000

# 预计时间：< 2分钟
```

---

## 扩容指南

### 水平扩容（增加后端实例）

```bash
# 修改docker-compose配置
vim docker-compose.production.yml

# 增加backend副本数
services:
  backend:
    deploy:
      replicas: 3  # 增加到3个实例

# 重启服务
docker-compose -f docker-compose.production.yml up -d --scale backend=3
```

---

### 垂直扩容（增加资源）

```bash
# 修改Docker资源限制
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '4'      # 从2增加到4
          memory: 4G     # 从2G增加到4G
```

---

## 性能调优

### MySQL优化

```bash
# 编辑MySQL配置
vim config/mysql/conf.d/custom.cnf

# 增加连接数
max_connections=500

# 增加缓冲池
innodb_buffer_pool_size=2G
```

---

### Redis优化

```bash
# 编辑Redis配置
vim config/redis/redis.conf

# 设置最大内存
maxmemory 2gb

# 设置淘汰策略
maxmemory-policy allkeys-lru
```

---

## 灾难恢复

### 完整恢复流程

```bash
# 1. 准备新服务器
bash ops/bootstrap.sh

# 2. 恢复配置
cp backup/.env .env

# 3. 恢复数据库
bash ops/backup_restore.sh restore 20251011-150000

# 4. 启动服务
bash ops/deploy.sh

# 预计时间：10-15分钟
```

---

## 联系支持

- **GitHub Issues**: https://github.com/zhihang9978/im-suite/issues
- **文档**: https://github.com/zhihang9978/im-suite/docs

---

**更新时间**: 2025-10-11  
**版本**: v1.0.0  
**维护者**: zhihang9978

