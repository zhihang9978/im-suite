# ğŸš€ å¿—èˆªå¯†ä¿¡ - ç”Ÿäº§éƒ¨ç½²æ‰‹å†Œ

## ğŸ“‹ ç›®å½•

1. [éƒ¨ç½²å‰å‡†å¤‡](#éƒ¨ç½²å‰å‡†å¤‡)
2. [æœåŠ¡å™¨é…ç½®](#æœåŠ¡å™¨é…ç½®)
3. [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
4. [TURN/SFUé…ç½®](#turnsfué…ç½®)
5. [HTTPSé…ç½®](#httpsé…ç½®)
6. [ç›‘æ§é…ç½®](#ç›‘æ§é…ç½®)
7. [éªŒè¯éƒ¨ç½²](#éªŒè¯éƒ¨ç½²)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## éƒ¨ç½²å‰å‡†å¤‡

### ç¡¬ä»¶è¦æ±‚

**æœ€ä½é…ç½®ï¼ˆæ”¯æŒ100å¹¶å‘ç”¨æˆ·ï¼‰**:
- CPU: 4æ ¸å¿ƒ
- å†…å­˜: 8GB
- ç£ç›˜: 100GB SSD
- å¸¦å®½: 100Mbps

**æ¨èé…ç½®ï¼ˆæ”¯æŒ300+å¹¶å‘ç”¨æˆ·ï¼‰**:
- CPU: 8æ ¸å¿ƒ+
- å†…å­˜: 16GB+
- ç£ç›˜: 500GB SSD
- å¸¦å®½: 1Gbps
- å¤šå…¬ç½‘IPï¼ˆWebRTCä¼˜åŒ–ï¼‰

### è½¯ä»¶è¦æ±‚

- æ“ä½œç³»ç»Ÿ: Ubuntu 20.04/22.04 æˆ– CentOS 7/8
- Docker: 20.10+
- Docker Compose: 2.0+
- Git: 2.x+
- Nginx: 1.18+

### åŸŸåå’Œè¯ä¹¦

- å‡†å¤‡åŸŸåï¼ˆå¦‚ï¼š`im.example.com`ï¼‰
- DNSè§£æå·²é…ç½®
- å‡†å¤‡SSLè¯ä¹¦ï¼ˆLet's Encryptæˆ–å•†ä¸šè¯ä¹¦ï¼‰

### ç½‘ç»œè¦æ±‚

- å¼€æ”¾ç«¯å£ï¼š
  - 22 (SSH)
  - 80 (HTTP)
  - 443 (HTTPS)
  - 3478 (TURN TCP/UDP)
  - 5349 (TURN TLS)
  - 49152-65535 (WebRTC UDP)

---

## æœåŠ¡å™¨é…ç½®

### 1. ç³»ç»Ÿåˆå§‹åŒ–

```bash
# ä»¥rootç”¨æˆ·ç™»å½•æœåŠ¡å™¨

# å…‹éš†é¡¹ç›®
cd /opt
git clone https://github.com/zhihang9978/im-suite.git
cd im-suite

# æ‰§è¡Œç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬
sudo bash ops/bootstrap.sh
```

**æ­¤è„šæœ¬å°†ï¼š**
- âœ… å®‰è£…ç³»ç»Ÿä¾èµ–
- âœ… å®‰è£…Dockerå’ŒDocker Compose
- âœ… ä¼˜åŒ–å†…æ ¸å‚æ•°ï¼ˆBBRã€æ–‡ä»¶æè¿°ç¬¦ç­‰ï¼‰
- âœ… é…ç½®é˜²ç«å¢™è§„åˆ™
- âœ… é…ç½®æ—¥å¿—è½®è½¬
- âœ… å®‰è£…coturnï¼ˆTURNæœåŠ¡å™¨ï¼‰
- âœ… åˆ›å»ºç³»ç»ŸæœåŠ¡

**é¢„è®¡æ—¶é—´**: 5-10åˆ†é’Ÿ

---

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp ENV_EXAMPLE.md .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim .env
```

**å¿…é¡»é…ç½®çš„å…³é”®å˜é‡**:

```bash
# åº”ç”¨é…ç½®
APP_BASE_URL=https://im.example.com

# æ•°æ®åº“å¯†ç ï¼ˆä½¿ç”¨å¼ºå¯†ç ï¼‰
MYSQL_ROOT_PASSWORD=$(openssl rand -base64 32)
MYSQL_PASSWORD=$(openssl rand -base64 32)

# Rediså¯†ç 
REDIS_PASSWORD=$(openssl rand -base64 32)

# MinIOå¯†ç 
MINIO_ROOT_PASSWORD=$(openssl rand -base64 32)

# JWTå¯†é’¥ï¼ˆ48å­—ç¬¦ä»¥ä¸Šï¼‰
JWT_SECRET=$(openssl rand -base64 48)

# åŠ å¯†å¯†é’¥
ENCRYPTION_KEY=$(openssl rand -base64 32)

# ç®¡ç†å‘˜ä¿¡æ¯
ADMIN_EMAIL=admin@example.com
ADMIN_PHONE=13800138000
ADMIN_PASSWORD=YourStrongPassword123!

# TURNé…ç½®
TURN_SERVER=turn:im.example.com:3478
TURN_USERNAME=turn_user
TURN_PASSWORD=$(openssl rand -base64 24)
TURN_REALM=example.com
TURN_PUBLIC_IPS=1.2.3.4,5.6.7.8  # æ‚¨çš„å…¬ç½‘IP

# CORSé…ç½®
CORS_ALLOWED_ORIGINS=https://im.example.com,https://www.example.com

# å®‰å…¨é…ç½®
DEBUG=false
SWAGGER_ENABLED=false
RATE_LIMIT_ENABLED=true

# ç›‘æ§é…ç½®
METRICS_ENABLED=true
SENTRY_ENABLED=false  # å¯é€‰
```

**éªŒè¯é…ç½®**:

```bash
# æ£€æŸ¥å¿…éœ€å˜é‡
bash ops/validate-env.sh
```

---

## éƒ¨ç½²æ­¥éª¤

### æ–¹æ³•1ï¼šä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰

```bash
cd /opt/im-suite

# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
sudo bash ops/deploy.sh
```

**éƒ¨ç½²æµç¨‹**:
1. âœ… å‰ç½®æ£€æŸ¥ï¼ˆç¯å¢ƒå˜é‡ã€ä¾èµ–ï¼‰
2. âœ… å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
3. âœ… æ‹‰å–æœ€æ–°ä»£ç 
4. âœ… æ„å»ºDockeré•œåƒ
5. âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»
6. âœ… é›¶åœæœºéƒ¨ç½²ï¼ˆè“ç»¿åˆ‡æ¢ï¼‰
7. âœ… å¥åº·æ£€æŸ¥
8. âœ… æ¸…ç†æ—§é•œåƒ

**é¢„è®¡æ—¶é—´**: 5-15åˆ†é’Ÿï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰

---

### æ–¹æ³•2ï¼šæ‰‹åŠ¨éƒ¨ç½²

```bash
cd /opt/im-suite

# 1. æ„å»ºé•œåƒ
docker-compose -f docker-compose.production.yml build

# 2. å¯åŠ¨æœåŠ¡
docker-compose -f docker-compose.production.yml up -d

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.production.yml logs -f

# 4. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.production.yml ps
```

---

## TURN/SFUé…ç½®

### é…ç½®TURNæœåŠ¡å™¨

```bash
# æ‰§è¡ŒTURNé…ç½®è„šæœ¬
sudo bash ops/setup-turn.sh
```

**äº¤äº’å¼é…ç½®**:
- è¾“å…¥åŸŸå: `im.example.com`
- è¾“å…¥å…¬ç½‘IP: `1.2.3.4,5.6.7.8`ï¼ˆé€—å·åˆ†éš”ï¼‰
- è¾“å…¥ç”¨æˆ·å: `turn_user`
- è¾“å…¥å¯†ç : ï¼ˆè‡ªåŠ¨ç”Ÿæˆæˆ–æ‰‹åŠ¨è¾“å…¥ï¼‰

**éªŒè¯TURN**:

åœ¨çº¿æµ‹è¯•: https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/

é…ç½®å‚æ•°:
```
STUN/TURN URI: turn:im.example.com:3478
Username: turn_user
Password: ï¼ˆæ‚¨è®¾ç½®çš„å¯†ç ï¼‰
```

**é¢„æœŸç»“æœ**: åº”è¯¥çœ‹åˆ° `relay` ç±»å‹çš„å€™é€‰é¡¹

---

### é…ç½®SFUï¼ˆå¯é€‰ï¼Œç”¨äºå¤šæ–¹é€šè¯ï¼‰

```bash
# ä½¿ç”¨Docker Composeéƒ¨ç½²ion-sfu
docker-compose -f docker-compose.sfu.yml up -d
```

**ion-sfué…ç½®** (`config/webrtc/sfu.yaml`):
```yaml
sfu:
  ballast: 20MiB
  withstats: true

webrtc:
  iceportrange: [5000, 5200]
  icelite: true
  candidates:
    - network: udp
      ip: 1.2.3.4  # æ‚¨çš„å…¬ç½‘IP
      port: 5000
      portmax: 5200
```

---

## HTTPSé…ç½®

### æ–¹æ³•1ï¼šä½¿ç”¨Let's Encryptï¼ˆæ¨èï¼‰

```bash
# æ‰§è¡ŒSSLé…ç½®è„šæœ¬
sudo bash ops/setup-ssl.sh
```

**é€‰æ‹©**: 1 (Let's Encrypt)

**äº¤äº’å¼é…ç½®**:
- åŸŸå: `im.example.com`
- é‚®ç®±: `admin@example.com`

**è‡ªåŠ¨å®Œæˆ**:
- âœ… ç”³è¯·SSLè¯ä¹¦
- âœ… é…ç½®Nginx HTTPS
- âœ… HTTPè‡ªåŠ¨è·³è½¬HTTPS
- âœ… é…ç½®å®‰å…¨å¤´ï¼ˆHSTSã€CSPç­‰ï¼‰
- âœ… é…ç½®è‡ªåŠ¨ç»­æœŸï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹ï¼‰

---

### æ–¹æ³•2ï¼šæ‰‹åŠ¨é…ç½®ï¼ˆå·²æœ‰è¯ä¹¦ï¼‰

```bash
# 1. ä¸Šä¼ è¯ä¹¦æ–‡ä»¶
scp your-cert.crt root@server:/opt/im-suite/ssl/
scp your-key.key root@server:/opt/im-suite/ssl/

# 2. æ‰§è¡Œé…ç½®è„šæœ¬å¹¶é€‰æ‹©"å¯¼å…¥è¯ä¹¦"
sudo bash ops/setup-ssl.sh
# é€‰æ‹©: 3 (å¯¼å…¥è¯ä¹¦)
```

---

### éªŒè¯HTTPS

```bash
# æœ¬åœ°æµ‹è¯•
curl -I https://im.example.com

# SSLè¯„åˆ†æµ‹è¯•
# è®¿é—®: https://www.ssllabs.com/ssltest/
# ç›®æ ‡è¯„åˆ†: A+ æˆ– A
```

---

## ç›‘æ§é…ç½®

### å¯åŠ¨ç›‘æ§æœåŠ¡

```bash
# å¯åŠ¨Prometheuså’ŒGrafana
docker-compose -f docker-compose.monitoring.yml up -d
```

**è®¿é—®åœ°å€**:
- Prometheus: http://server-ip:9090
- Grafana: http://server-ip:3000

**Grafanaé…ç½®**:

1. **ç™»å½•**:
   - ç”¨æˆ·å: `admin`
   - å¯†ç : `admin`ï¼ˆé¦–æ¬¡ç™»å½•åä¿®æ”¹ï¼‰

2. **æ·»åŠ æ•°æ®æº**:
   - ç±»å‹: Prometheus
   - URL: `http://prometheus:9090`

3. **å¯¼å…¥é¢æ¿**:
   - ä¸Šä¼  `config/grafana/dashboards/im-suite-dashboard.json`

4. **é…ç½®å‘Šè­¦**:
   - æ·»åŠ å‘Šè­¦æ¸ é“ï¼ˆEmail/é’‰é’‰/ä¼ä¸šå¾®ä¿¡ï¼‰
   - é…ç½®å‘Šè­¦è§„åˆ™

---

## éªŒè¯éƒ¨ç½²

### 1. å¥åº·æ£€æŸ¥

```bash
# åç«¯å¥åº·æ£€æŸ¥
curl http://localhost:8080/health

# é¢„æœŸå“åº”
{
  "status": "healthy",
  "timestamp": "2025-10-11T16:00:00Z"
}
```

### 2. æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.production.yml ps

# é¢„æœŸï¼šæ‰€æœ‰æœåŠ¡çŠ¶æ€ä¸º "Up (healthy)"
```

### 3. æ—¥å¿—æ£€æŸ¥

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
docker logs im-backend-prod --tail=100

# æŸ¥çœ‹Nginxæ—¥å¿—
tail -f /var/log/nginx/access.log
```

### 4. æ€§èƒ½æµ‹è¯•

```bash
# è¿è¡Œå‹åŠ›æµ‹è¯•
bash ops/loadtest.sh

# æ£€æŸ¥ç»“æœ
cat loadtest-reports/report-*.json
```

**ç›®æ ‡SLO**:
- âœ… ç™»å½•API P95 < 200ms
- âœ… å¹¶å‘300ç”¨æˆ·ï¼Œé”™è¯¯ç‡ < 0.1%
- âœ… WebRTC 20è·¯720på¹¶å‘

---

### 5. ç«¯åˆ°ç«¯æµ‹è¯•

```bash
# è¿è¡ŒE2Eæµ‹è¯•
bash ops/e2e-test.sh

# é¢„æœŸï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡
```

**æµ‹è¯•æµç¨‹**:
1. âœ… ç”¨æˆ·æ³¨å†Œ
2. âœ… ç”¨æˆ·ç™»å½•
3. âœ… å‘é€æ–‡æœ¬æ¶ˆæ¯
4. âœ… å‘é€å›¾ç‰‡
5. âœ… è¯­éŸ³é€šè¯
6. âœ… è§†é¢‘é€šè¯

---

## å¤‡ä»½é…ç½®

### é…ç½®è‡ªåŠ¨å¤‡ä»½

```bash
# é…ç½®æ¯æ—¥è‡ªåŠ¨å¤‡ä»½ï¼ˆå‡Œæ™¨2ç‚¹ï¼‰
(crontab -l 2>/dev/null; echo "0 2 * * * cd /opt/im-suite && bash ops/backup_restore.sh backup") | crontab -
```

### æ‰‹åŠ¨å¤‡ä»½

```bash
# ç«‹å³æ‰§è¡Œå¤‡ä»½
bash ops/backup_restore.sh backup

# æŸ¥çœ‹å¤‡ä»½
ls -lh /opt/im-suite/backups/
```

---

## å¸¸è§é—®é¢˜

### Q1: éƒ¨ç½²å¤±è´¥ï¼Œå¥åº·æ£€æŸ¥è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs im-backend-prod --tail=100

# å¸¸è§åŸå› ï¼š
# 1. æ•°æ®åº“è¿æ¥å¤±è´¥ -> æ£€æŸ¥MYSQL_PASSWORD
# 2. Redisè¿æ¥å¤±è´¥ -> æ£€æŸ¥REDIS_PASSWORD
# 3. ç«¯å£è¢«å ç”¨ -> netstat -tulpn | grep 8080
```

---

### Q2: å‰ç«¯æ— æ³•è®¿é—®åç«¯APIï¼ˆCORSé”™è¯¯ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥CORSé…ç½®
grep CORS_ALLOWED_ORIGINS .env

# å¿…é¡»åŒ…å«å‰ç«¯åŸŸå
CORS_ALLOWED_ORIGINS=https://im.example.com
```

---

### Q3: WebRTCè¿æ¥å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥TURNæœåŠ¡å™¨çŠ¶æ€
systemctl status coturn

# 2. æ£€æŸ¥é˜²ç«å¢™
ufw status | grep -E "(3478|5349|49152)"

# 3. æµ‹è¯•TURNè¿æ¥
# è®¿é—®: https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/
```

---

### Q4: SSLè¯ä¹¦ç»­æœŸå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ‰‹åŠ¨ç»­æœŸ
certbot renew --dry-run  # æµ‹è¯•
certbot renew            # å®é™…ç»­æœŸ

# é‡å¯Nginx
systemctl reload nginx
```

---

### Q5: æ•°æ®åº“è¿ç§»å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker exec -it im-mysql-prod mysql -uroot -p

# 2. æ‰‹åŠ¨è¿è¡Œè¿ç§»
docker exec -it im-backend-prod go run main.go migrate

# 3. å¦‚æœä»ç„¶å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—
docker logs im-backend-prod | grep "migration"
```

---

## å›æ»šæ“ä½œ

### å¿«é€Ÿå›æ»š

```bash
# æŸ¥çœ‹å¯ç”¨çš„å¤‡ä»½ç‰ˆæœ¬
ls -lt /opt/im-suite/backups/deployments/

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
bash ops/rollback.sh 20251011-150000

# é¢„è®¡æ—¶é—´ï¼š< 2åˆ†é’Ÿ
```

---

## æ‰©å®¹æŒ‡å—

### æ°´å¹³æ‰©å®¹ï¼ˆå¢åŠ åç«¯å®ä¾‹ï¼‰

```bash
# ä¿®æ”¹docker-composeé…ç½®
vim docker-compose.production.yml

# å¢åŠ backendå‰¯æœ¬æ•°
services:
  backend:
    deploy:
      replicas: 3  # å¢åŠ åˆ°3ä¸ªå®ä¾‹

# é‡å¯æœåŠ¡
docker-compose -f docker-compose.production.yml up -d --scale backend=3
```

---

### å‚ç›´æ‰©å®¹ï¼ˆå¢åŠ èµ„æºï¼‰

```bash
# ä¿®æ”¹Dockerèµ„æºé™åˆ¶
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '4'      # ä»2å¢åŠ åˆ°4
          memory: 4G     # ä»2Gå¢åŠ åˆ°4G
```

---

## æ€§èƒ½è°ƒä¼˜

### MySQLä¼˜åŒ–

```bash
# ç¼–è¾‘MySQLé…ç½®
vim config/mysql/conf.d/custom.cnf

# å¢åŠ è¿æ¥æ•°
max_connections=500

# å¢åŠ ç¼“å†²æ± 
innodb_buffer_pool_size=2G
```

---

### Redisä¼˜åŒ–

```bash
# ç¼–è¾‘Redisé…ç½®
vim config/redis/redis.conf

# è®¾ç½®æœ€å¤§å†…å­˜
maxmemory 2gb

# è®¾ç½®æ·˜æ±°ç­–ç•¥
maxmemory-policy allkeys-lru
```

---

## ç¾éš¾æ¢å¤

### å®Œæ•´æ¢å¤æµç¨‹

```bash
# 1. å‡†å¤‡æ–°æœåŠ¡å™¨
bash ops/bootstrap.sh

# 2. æ¢å¤é…ç½®
cp backup/.env .env

# 3. æ¢å¤æ•°æ®åº“
bash ops/backup_restore.sh restore 20251011-150000

# 4. å¯åŠ¨æœåŠ¡
bash ops/deploy.sh

# é¢„è®¡æ—¶é—´ï¼š10-15åˆ†é’Ÿ
```

---

## è”ç³»æ”¯æŒ

- **GitHub Issues**: https://github.com/zhihang9978/im-suite/issues
- **æ–‡æ¡£**: https://github.com/zhihang9978/im-suite/docs

---

**æ›´æ–°æ—¶é—´**: 2025-10-11  
**ç‰ˆæœ¬**: v1.0.0  
**ç»´æŠ¤è€…**: zhihang9978

