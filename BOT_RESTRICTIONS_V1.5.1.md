# æœºå™¨äººæƒé™é™åˆ¶ v1.5.1 - å®ŒæˆæŠ¥å‘Š

**ç‰ˆæœ¬**: v1.5.1  
**æ›´æ–°æ—¥æœŸ**: 2024-12-19  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æ¨é€

---

## ğŸ¯ éœ€æ±‚å›é¡¾

ç”¨æˆ·è¦æ±‚é™åˆ¶æœºå™¨äººæƒé™ï¼š
1. **åªèƒ½åˆ›å»ºæ™®é€šç”¨æˆ·** - ä¸èƒ½åˆ›å»ºç®¡ç†å‘˜
2. **åªèƒ½åˆ é™¤æˆæƒçš„ç”¨æˆ·** - åªèƒ½åˆ é™¤è‡ªå·±åˆ›å»ºçš„ç”¨æˆ·
3. **ç§»é™¤å°ç¦åŠŸèƒ½** - æå‡å®‰å…¨æ€§

---

## âœ… å®Œæˆçš„æ”¹åŠ¨

### 1. æ•°æ®æ¨¡å‹å±‚ï¼ˆUseræ¨¡å‹ï¼‰

**æ–‡ä»¶**: `im-backend/internal/model/user.go`

**æ–°å¢å­—æ®µ**:
```go
// æœºå™¨äººç®¡ç†ä¿¡æ¯
CreatedByBotID *uint `json:"created_by_bot_id,omitempty"` // åˆ›å»ºè¯¥ç”¨æˆ·çš„æœºå™¨äººID
BotManageable  bool  `json:"bot_manageable" gorm:"default:false"` // æ˜¯å¦å…è®¸æœºå™¨äººç®¡ç†
```

**ä½œç”¨**:
- `CreatedByBotID`: æ ‡è®°ç”¨æˆ·ç”±å“ªä¸ªæœºå™¨äººåˆ›å»ºï¼ˆnullè¡¨ç¤ºéæœºå™¨äººåˆ›å»ºï¼‰
- `BotManageable`: æ ‡è®°ç”¨æˆ·æ˜¯å¦å…è®¸è¢«æœºå™¨äººç®¡ç†

---

### 2. æœåŠ¡å±‚ï¼ˆBot Serviceï¼‰

**æ–‡ä»¶**: `im-backend/internal/service/bot_service.go`

#### ä¿®æ”¹1: BotCreateUserï¼ˆåˆ›å»ºç”¨æˆ·ï¼‰

**æ”¹åŠ¨å‰**:
```go
// è§’è‰²éªŒè¯ï¼ˆæœºå™¨äººä¸èƒ½åˆ›å»ºsuper_adminï¼‰
role := req.Role
if role == "" {
    role = "user"
}
if role == "super_admin" {
    return nil, errors.New("æœºå™¨äººä¸èƒ½åˆ›å»ºè¶…çº§ç®¡ç†å‘˜è´¦å·")
}
if role != "user" && role != "admin" {
    return nil, errors.New("æ— æ•ˆçš„è§’è‰²")
}
```

**æ”¹åŠ¨å**:
```go
// æœºå™¨äººåªèƒ½åˆ›å»ºæ™®é€šç”¨æˆ·ï¼Œå¿½ç•¥è¯·æ±‚ä¸­çš„roleå­—æ®µ
user := model.User{
    // ...
    Role:           "user", // å›ºå®šä¸ºæ™®é€šç”¨æˆ·
    CreatedByBotID: &bot.ID,      // æ ‡è®°åˆ›å»ºè€…æœºå™¨äºº
    BotManageable:  true,          // å…è®¸æœºå™¨äººç®¡ç†
}
```

**ç»“æœ**: 
- âœ… å¼ºåˆ¶role="user"
- âœ… è‡ªåŠ¨è®¾ç½®CreatedByBotID
- âœ… è‡ªåŠ¨è®¾ç½®BotManageable=true

#### ä¿®æ”¹2: BotDeleteUserï¼ˆåˆ é™¤ç”¨æˆ·ï¼‰

**æ–°å¢æ£€æŸ¥**:
```go
// åªèƒ½åˆ é™¤è¢«æ ‡è®°ä¸ºå¯è¢«æœºå™¨äººç®¡ç†çš„ç”¨æˆ·
if !user.BotManageable {
    return errors.New("è¯¥ç”¨æˆ·ä¸å…è®¸è¢«æœºå™¨äººç®¡ç†")
}

// åªèƒ½åˆ é™¤è‡ªå·±åˆ›å»ºçš„ç”¨æˆ·
if user.CreatedByBotID == nil || *user.CreatedByBotID != bot.ID {
    return errors.New("åªèƒ½åˆ é™¤æœ¬æœºå™¨äººåˆ›å»ºçš„ç”¨æˆ·")
}
```

**ç»“æœ**: 
- âœ… åªèƒ½åˆ é™¤BotManageable=trueçš„ç”¨æˆ·
- âœ… åªèƒ½åˆ é™¤CreatedByBotIDç­‰äºå½“å‰æœºå™¨äººIDçš„ç”¨æˆ·

#### ç§»é™¤æ–¹æ³•:
- âŒ `BotBanUser` - å°ç¦ç”¨æˆ·ï¼ˆå·²åˆ é™¤ï¼‰
- âŒ `BotUnbanUser` - è§£å°ç”¨æˆ·ï¼ˆå·²åˆ é™¤ï¼‰

---

### 3. æ§åˆ¶å™¨å±‚ï¼ˆBot Controllerï¼‰

**æ–‡ä»¶**: `im-backend/internal/controller/bot_controller.go`

**ä¿ç•™æ–¹æ³•**:
- âœ… `BotCreateUser` - åˆ›å»ºæ™®é€šç”¨æˆ·
- âœ… `BotDeleteUser` - åˆ é™¤è‡ªå·±åˆ›å»ºçš„ç”¨æˆ·

**ç§»é™¤æ–¹æ³•**:
- âŒ `BotBanUser` - å°ç¦ç”¨æˆ·
- âŒ `BotUnbanUser` - è§£å°ç”¨æˆ·

**æ³¨é‡Šæ›´æ–°**:
```go
// ========================================
// æœºå™¨äººAPIç«¯ç‚¹ï¼ˆä½¿ç”¨API Keyè®¤è¯ï¼‰
// é™åˆ¶ï¼šä»…èƒ½åˆ›å»ºæ™®é€šç”¨æˆ·å’Œåˆ é™¤è‡ªå·±åˆ›å»ºçš„ç”¨æˆ·
// ========================================

// BotCreateUser æœºå™¨äººåˆ›å»ºç”¨æˆ·ï¼ˆä»…é™æ™®é€šç”¨æˆ·ï¼‰
// BotDeleteUser æœºå™¨äººåˆ é™¤ç”¨æˆ·ï¼ˆä»…é™è‡ªå·±åˆ›å»ºçš„ç”¨æˆ·ï¼‰
```

---

### 4. è·¯ç”±å±‚ï¼ˆMainï¼‰

**æ–‡ä»¶**: `im-backend/main.go`

**æ”¹åŠ¨å‰**:
```go
botAPI := api.Group("/bot")
botAPI.Use(middleware.BotAuthMiddleware())
{
    botAPI.POST("/users", botController.BotCreateUser)
    botAPI.POST("/users/ban", botController.BotBanUser)
    botAPI.POST("/users/:user_id/unban", botController.BotUnbanUser)
    botAPI.DELETE("/users", botController.BotDeleteUser)
}
```

**æ”¹åŠ¨å**:
```go
botAPI := api.Group("/bot")
botAPI.Use(middleware.BotAuthMiddleware())
{
    // ç”¨æˆ·ç®¡ç†ï¼ˆä»…é™åˆ›å»ºå’Œåˆ é™¤æ™®é€šç”¨æˆ·ï¼‰
    botAPI.POST("/users", botController.BotCreateUser)      // åˆ›å»ºæ™®é€šç”¨æˆ·
    botAPI.DELETE("/users", botController.BotDeleteUser)    // åˆ é™¤è‡ªå·±åˆ›å»ºçš„ç”¨æˆ·
}
```

**ç»“æœ**: 
- âœ… ä¿ç•™2ä¸ªAPIç«¯ç‚¹
- âŒ ç§»é™¤2ä¸ªAPIç«¯ç‚¹ï¼ˆbanã€unbanï¼‰

---

### 5. æ–‡æ¡£å±‚

**æ–°å¢æ–‡æ¡£**: `docs/api/bot-api-restricted.md`

**å†…å®¹**:
- ğŸ“ å—é™ç‰ˆæœ¬APIæ–‡æ¡£
- ğŸ“ æƒé™é™åˆ¶è¯¦ç»†è¯´æ˜
- ğŸ“ å®‰å…¨æœºåˆ¶è§£é‡Š
- ğŸ“ Python/Node.jsä½¿ç”¨ç¤ºä¾‹
- ğŸ“ å¸¸è§é—®é¢˜FAQ
- ğŸ“ åº”ç”¨åœºæ™¯ç¤ºä¾‹

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½ | v1.5.0ï¼ˆå®Œæ•´ç‰ˆï¼‰ | v1.5.1ï¼ˆå—é™ç‰ˆï¼‰ |
|------|------------------|------------------|
| **åˆ›å»ºç”¨æˆ·** | âœ… æ”¯æŒuser/admin | âœ… ä»…user |
| **åˆ é™¤ç”¨æˆ·** | âœ… æ‰€æœ‰ésuper_admin | âœ… ä»…è‡ªå·±åˆ›å»ºçš„ |
| **å°ç¦ç”¨æˆ·** | âœ… æ”¯æŒ | âŒ ç§»é™¤ |
| **è§£å°ç”¨æˆ·** | âœ… æ”¯æŒ | âŒ ç§»é™¤ |
| **ç”¨æˆ·æ ‡è®°** | âŒ æ—  | âœ… CreatedByBotID |
| **æƒé™æ§åˆ¶** | âš ï¸ è¾ƒå®½æ¾ | âœ… ä¸¥æ ¼é™åˆ¶ |

---

## ğŸ” å®‰å…¨æå‡

### 1. é˜²æ­¢è·¨è¶Šæƒé™è¾¹ç•Œ
- **v1.5.0**: æœºå™¨äººå¯ä»¥åˆ›å»ºadminç”¨æˆ·
- **v1.5.1**: æœºå™¨äººåªèƒ½åˆ›å»ºuserç”¨æˆ· âœ…

### 2. é˜²æ­¢è¯¯åˆ å…¶ä»–ç”¨æˆ·
- **v1.5.0**: å¯ä»¥åˆ é™¤ä»»ä½•ésuper_adminç”¨æˆ·
- **v1.5.1**: åªèƒ½åˆ é™¤è‡ªå·±åˆ›å»ºçš„ç”¨æˆ· âœ…

### 3. é™ä½æ»¥ç”¨é£é™©
- **v1.5.0**: æœ‰å°ç¦/è§£å°åŠŸèƒ½ï¼Œå¯èƒ½è¢«æ»¥ç”¨
- **v1.5.1**: ç§»é™¤å°ç¦åŠŸèƒ½ï¼Œåªä¿ç•™åŸºç¡€å¢åˆ  âœ…

### 4. å¯å®¡è®¡è¿½è¸ª
- **v1.5.0**: æ— æ³•è¿½è¸ªç”¨æˆ·åˆ›å»ºæ¥æº
- **v1.5.1**: é€šè¿‡CreatedByBotIDå¯è¿½è¸ª âœ…

---

## ğŸ”„ å·¥ä½œæµç¨‹

### åˆ›å»ºç”¨æˆ·æµç¨‹
```
1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚ POST /api/bot/users
   â†“
2. BotAuthMiddlewareéªŒè¯API Key/Secret
   â†“
3. BotController.BotCreateUseræ¥æ”¶è¯·æ±‚
   â†“
4. BotService.BotCreateUser:
   - æ£€æŸ¥æƒé™
   - éªŒè¯æ‰‹æœºå·/ç”¨æˆ·åå”¯ä¸€æ€§
   - å¼ºåˆ¶è®¾ç½®role="user"
   - è®¾ç½®CreatedByBotID=bot.ID
   - è®¾ç½®BotManageable=true
   - åˆ›å»ºç”¨æˆ·
   - è®°å½•æ—¥å¿—
   â†“
5. è¿”å›æˆåŠŸå“åº”
```

### åˆ é™¤ç”¨æˆ·æµç¨‹
```
1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚ DELETE /api/bot/users
   â†“
2. BotAuthMiddlewareéªŒè¯API Key/Secret
   â†“
3. BotController.BotDeleteUseræ¥æ”¶è¯·æ±‚
   â†“
4. BotService.BotDeleteUser:
   - æ£€æŸ¥æƒé™
   - æŸ¥æ‰¾ç”¨æˆ·
   - æ£€æŸ¥BotManageable=true âœ…
   - æ£€æŸ¥CreatedByBotID==bot.ID âœ…
   - è½¯åˆ é™¤ç”¨æˆ·
   - è®°å½•æ—¥å¿—
   â†“
5. è¿”å›æˆåŠŸå“åº”
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### Pythonç¤ºä¾‹

```python
import requests

# é…ç½®
API_KEY = "bot_abc123..."
API_SECRET = "789ghi..."
BASE_URL = "http://localhost:8080"

headers = {
    "X-Bot-Auth": f"Bot {API_KEY}:{API_SECRET}",
    "Content-Type": "application/json"
}

# åˆ›å»ºç”¨æˆ·ï¼ˆè‡ªåŠ¨ä¸ºæ™®é€šç”¨æˆ·ï¼‰
def create_user(phone, username, password):
    response = requests.post(
        f"{BASE_URL}/api/bot/users",
        json={
            "phone": phone,
            "username": username,
            "password": password
            # ä¸éœ€è¦æä¾›roleå­—æ®µ
        },
        headers=headers
    )
    return response.json()

# åˆ é™¤ç”¨æˆ·ï¼ˆä»…é™è‡ªå·±åˆ›å»ºçš„ï¼‰
def delete_user(user_id, reason):
    response = requests.delete(
        f"{BASE_URL}/api/bot/users",
        json={
            "user_id": user_id,
            "reason": reason
        },
        headers=headers
    )
    return response.json()

# åˆ›å»ºç”¨æˆ·
result = create_user("13800138000", "testuser", "Pass123!")
print(result)
# è¾“å‡º: {"success": true, "data": {"id": 123, "role": "user", ...}}

# åˆ é™¤ç”¨æˆ·
result = delete_user(123, "æµ‹è¯•å®Œæˆ")
print(result)
# è¾“å‡º: {"success": true, "message": "ç”¨æˆ·å·²åˆ é™¤"}
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦é™åˆ¶åªèƒ½åˆ›å»ºæ™®é€šç”¨æˆ·ï¼Ÿ
**A**: ä¸ºäº†å®‰å…¨ï¼Œé˜²æ­¢æœºå™¨äººåˆ›å»ºç®¡ç†å‘˜è´¦å·ã€‚ç®¡ç†å‘˜è´¦å·åº”è¯¥ç”±è¶…çº§ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºã€‚

### Q2: å¦‚ä½•æŸ¥çœ‹æœºå™¨äººåˆ›å»ºäº†å“ªäº›ç”¨æˆ·ï¼Ÿ
**A**: æŸ¥è¯¢æ•°æ®åº“ï¼š
```sql
SELECT * FROM users 
WHERE created_by_bot_id = {bot_id} 
AND deleted_at IS NULL;
```

### Q3: å¦‚æœéœ€è¦å°ç¦ç”¨æˆ·æ€ä¹ˆåŠï¼Ÿ
**A**: ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜è´¦å·é€šè¿‡ç®¡ç†APIæ“ä½œï¼š
```bash
POST /api/super-admin/users/{id}/ban
```

### Q4: æœºå™¨äººAèƒ½åˆ é™¤æœºå™¨äººBåˆ›å»ºçš„ç”¨æˆ·å—ï¼Ÿ
**A**: ä¸èƒ½ã€‚æ¯ä¸ªæœºå™¨äººåªèƒ½åˆ é™¤è‡ªå·±åˆ›å»ºçš„ç”¨æˆ·ï¼ˆé€šè¿‡CreatedByBotIDæ£€æŸ¥ï¼‰ã€‚

### Q5: å¦‚ä½•å‡çº§å·²æœ‰çš„æœºå™¨äººï¼Ÿ
**A**: æ•°æ®åº“ä¼šè‡ªåŠ¨è¿ç§»æ·»åŠ æ–°å­—æ®µã€‚å·²æœ‰ç”¨æˆ·çš„`CreatedByBotID`ä¸ºnullï¼Œæ— æ³•è¢«æœºå™¨äººåˆ é™¤ï¼ˆå®‰å…¨ï¼‰ã€‚

---

## ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯

### ä»£ç æ”¹åŠ¨
- **ä¿®æ”¹æ–‡ä»¶**: 5ä¸ª
- **æ–°å¢æ–‡ä»¶**: 1ä¸ª
- **åˆ é™¤ä»£ç **: çº¦150è¡Œ
- **æ–°å¢ä»£ç **: çº¦120è¡Œ
- **å‡€å˜åŒ–**: -30è¡Œï¼ˆæ›´ç®€æ´ï¼‰

### APIç«¯ç‚¹
- **ç§»é™¤**: 2ä¸ªï¼ˆbanã€unbanï¼‰
- **ä¿ç•™**: 2ä¸ªï¼ˆcreateã€deleteï¼‰
- **æ€»æ•°**: ä»4ä¸ªå‡å°‘åˆ°2ä¸ª

### æ•°æ®åº“
- **æ–°å¢å­—æ®µ**: 2ä¸ª
- **æ–°å¢è¡¨**: 0ä¸ª

---

## ğŸ‰ æ€»ç»“

### å®Œæˆçš„ç›®æ ‡
âœ… **é™åˆ¶åˆ›å»ºæƒé™** - åªèƒ½åˆ›å»ºæ™®é€šç”¨æˆ·  
âœ… **é™åˆ¶åˆ é™¤æƒé™** - åªèƒ½åˆ é™¤è‡ªå·±åˆ›å»ºçš„ç”¨æˆ·  
âœ… **ç§»é™¤å°ç¦åŠŸèƒ½** - æå‡å®‰å…¨æ€§  
âœ… **æ·»åŠ ç”¨æˆ·æ ‡è®°** - å¯è¿½è¸ªåˆ›å»ºæ¥æº  
âœ… **æ›´æ–°æ–‡æ¡£** - å®Œæ•´çš„å—é™ç‰ˆæœ¬æ–‡æ¡£  

### å®‰å…¨ä¼˜åŠ¿
ğŸ”’ **é˜²æ­¢æƒé™æå‡** - ä¸èƒ½åˆ›å»ºç®¡ç†å‘˜  
ğŸ”’ **é˜²æ­¢è·¨æœºå™¨äººæ“ä½œ** - ä¸èƒ½åˆ é™¤å…¶ä»–æœºå™¨äººçš„ç”¨æˆ·  
ğŸ”’ **é™ä½æ»¥ç”¨é£é™©** - ç§»é™¤å°ç¦åŠŸèƒ½  
ğŸ”’ **å¯å®¡è®¡è¿½è¸ª** - è®°å½•åˆ›å»ºæ¥æº  

### ç¼–è¯‘çŠ¶æ€
âœ… **ç¼–è¯‘é€šè¿‡** - æ— é”™è¯¯æ— è­¦å‘Š  
âœ… **æ¨é€æˆåŠŸ** - å·²æ¨é€åˆ°GitHub  

---

**ç‰ˆæœ¬**: v1.5.1  
**å‘å¸ƒæ—¥æœŸ**: 2024-12-19  
**æäº¤**: d35205a  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

