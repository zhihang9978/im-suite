# æ•°æ®åº“è¿ç§»å®‰å…¨æœºåˆ¶

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨ä¼˜åŒ–çš„æ•°æ®åº“è¿ç§»æœºåˆ¶ï¼Œç¡®ä¿åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­ä¸ä¼šå› ä¸ºè¡¨ä¾èµ–é¡ºåºã€å¤–é”®çº¦æŸã€ç´¢å¼•é•¿åº¦ç­‰é—®é¢˜å¯¼è‡´å¤±è´¥ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. æ™ºèƒ½ä¾èµ–æ’åº
- âœ… è‡ªåŠ¨åˆ†æè¡¨ä¹‹é—´çš„å¤–é”®ä¾èµ–å…³ç³»
- âœ… æŒ‰ç…§ä¾èµ–é¡ºåºåˆ›å»ºè¡¨ï¼Œè¢«å¼•ç”¨çš„è¡¨ä¼˜å…ˆåˆ›å»º
- âœ… æ”¯æŒå¤æ‚çš„å¤šå±‚ä¾èµ–å…³ç³»

### 2. è¡¨å­˜åœ¨æ£€æµ‹
- âœ… è¿ç§»å‰æ£€æŸ¥è¡¨æ˜¯å¦å·²å­˜åœ¨
- âœ… å·²å­˜åœ¨çš„è¡¨åªæ‰§è¡Œç»“æ„æ›´æ–°
- âœ… é¿å…é‡å¤åˆ›å»ºå’Œå¾ªç¯ä¾èµ–

### 3. è¿ç§»åéªŒè¯
- âœ… è‡ªåŠ¨éªŒè¯æ‰€æœ‰å…³é”®è¡¨æ˜¯å¦æˆåŠŸåˆ›å»º
- âœ… æ‰“å°æ‰€æœ‰å·²åˆ›å»ºè¡¨çš„åˆ—è¡¨
- âœ… ç¼ºå¤±å…³é”®è¡¨æ—¶ç«‹å³æŠ¥é”™é€€å‡º

### 4. å­—æ®µé•¿åº¦è§„èŒƒ
- âœ… æ‰€æœ‰ `uniqueIndex` å­—æ®µæ˜ç¡®å£°æ˜ `varchar` é•¿åº¦
- âœ… Tokenã€Phoneã€Username ç­‰å­—æ®µé•¿åº¦åœ¨ 20~255 ä¹‹é—´
- âœ… é¿å… "Specified key was too long; max key length is 3072 bytes" é”™è¯¯

### 5. è¯¦ç»†æ—¥å¿—è¾“å‡º
- âœ… æ‰“å°å®Œæ•´çš„è¿ç§»é¡ºåºå’Œä¾èµ–å…³ç³»
- âœ… æ¯ä¸ªè¡¨çš„è¿ç§»çŠ¶æ€å®æ—¶æ˜¾ç¤º
- âœ… æˆåŠŸ/å¤±è´¥ä¿¡æ¯æ¸…æ™°æ ‡è¯†

## ğŸ“Š è¡¨ä¾èµ–å…³ç³»

### ç¬¬ä¸€å±‚ï¼šåŸºç¡€è¡¨ï¼ˆæ— å¤–é”®ä¾èµ–ï¼‰
```
users, chats, themes
```

### ç¬¬äºŒå±‚ï¼šä¾èµ–åŸºç¡€è¡¨
```
sessions â†’ users
contacts â†’ users
chat_members â†’ chats, users
user_theme_settings â†’ users, themes
```

### ç¬¬ä¸‰å±‚ï¼šæ¶ˆæ¯å›å¤é“¾
```
message_repliesï¼ˆè¢« messages å¼•ç”¨ï¼‰
```

### ç¬¬å››å±‚ï¼šæ¶ˆæ¯ä¸»è¡¨
```
messages â†’ users, chats, message_replies
```

### ç¬¬äº”å±‚ï¼šæ¶ˆæ¯ç›¸å…³è¡¨
```
message_reads â†’ messages, users
message_edits â†’ messages
message_recalls â†’ messages, users
message_forwards â†’ messages, users
... å…¶ä»–æ¶ˆæ¯ç›¸å…³è¡¨
```

### å…¶ä»–å±‚ï¼šæ–‡ä»¶ã€ç¾¤ç»„ã€å®‰å…¨ã€æœºå™¨äººã€å±å¹•å…±äº«ç­‰
```
files â†’ users
file_chunks â†’ files
bots â†’ users
bot_api_logs â†’ bots
screen_share_sessions â†’ users
... æ›´å¤šè¡¨
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### è‡ªåŠ¨è¿ç§»ï¼ˆæ¨èï¼‰

åç«¯å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œè¿ç§»ï¼š

```go
// im-backend/main.go
if err := config.AutoMigrate(); err != nil {
    log.Fatalf("æ•°æ®åº“è¿ç§»å¤±è´¥: %v", err)
}
```

### æ‰‹åŠ¨è¿ç§»

```go
import "zhihang-messenger/im-backend/config"

// æ‰§è¡Œè¿ç§»
err := config.MigrateTables(db)
if err != nil {
    log.Fatalf("è¿ç§»å¤±è´¥: %v", err)
}
```

### æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨

```go
exists := config.CheckTableExists(db, "users")
if exists {
    log.Println("users è¡¨å·²å­˜åœ¨")
}
```

### è·å–æ‰€æœ‰è¡¨åˆ—è¡¨

```go
tables, err := config.GetTableList(db)
if err != nil {
    log.Fatalf("è·å–è¡¨åˆ—è¡¨å¤±è´¥: %v", err)
}
for _, table := range tables {
    fmt.Println(table)
}
```

## ğŸ§ª å•å…ƒæµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
cd im-backend/config
go test -v
```

### è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# æµ‹è¯•è¿ç§»é¡ºåº
go test -v -run TestMigrationOrder

# æµ‹è¯•è¡¨ä¾èµ–å…³ç³»
go test -v -run TestTableDependencies

# æµ‹è¯•è¡¨éªŒè¯åŠŸèƒ½
go test -v -run TestVerifyTables
```

### åŸºå‡†æµ‹è¯•

```bash
go test -bench=BenchmarkMigration -benchmem
```

## ğŸ“ å­—æ®µé•¿åº¦è§„èŒƒ

### uniqueIndex å­—æ®µå¿…é¡»æ˜ç¡®é•¿åº¦

âŒ **é”™è¯¯ç¤ºä¾‹**ï¼š
```go
Phone string `json:"phone" gorm:"uniqueIndex;not null"`
Token string `json:"token" gorm:"uniqueIndex;not null"`
```

âœ… **æ­£ç¡®ç¤ºä¾‹**ï¼š
```go
Phone string `json:"phone" gorm:"type:varchar(20);uniqueIndex;not null"`
Token string `json:"token" gorm:"type:varchar(255);uniqueIndex;not null"`
```

### æ¨èå­—æ®µé•¿åº¦

| å­—æ®µç±»å‹ | æ¨èé•¿åº¦ | è¯´æ˜ |
|---------|---------|------|
| Phone | varchar(20) | æ‰‹æœºå· |
| Username | varchar(50) | ç”¨æˆ·å |
| Token | varchar(255) | ä»¤ç‰Œ/å¯†é’¥ |
| Email | varchar(100) | é‚®ç®±åœ°å€ |
| Nickname | varchar(100) | æ˜µç§° |
| URL | varchar(255) | URLåœ°å€ |
| IP | varchar(45) | IPåœ°å€ï¼ˆæ”¯æŒIPv6ï¼‰ |
| Bio/Description | varchar(500) | ç®€ä»‹/æè¿° |
| LongText | text | é•¿æ–‡æœ¬å†…å®¹ |

## ğŸš¨ å¸¸è§é—®é¢˜

### é—®é¢˜1ï¼šError 1824 - Failed to open the referenced table

**åŸå› **ï¼šè¢«å¼•ç”¨çš„è¡¨æœªåˆ›å»ºå°±å°è¯•åˆ›å»ºå¼•ç”¨è¡¨

**è§£å†³**ï¼šä½¿ç”¨æ–°çš„è¿ç§»æœºåˆ¶ï¼Œå·²è‡ªåŠ¨å¤„ç†ä¾èµ–é¡ºåº

### é—®é¢˜2ï¼šSpecified key was too long; max key length is 3072 bytes

**åŸå› **ï¼šuniqueIndex å­—æ®µé•¿åº¦è¿‡é•¿æˆ–æœªæŒ‡å®šé•¿åº¦

**è§£å†³**ï¼šæ˜ç¡®æŒ‡å®š varchar é•¿åº¦ï¼Œå»ºè®®ä¸è¶…è¿‡ 255

### é—®é¢˜3ï¼šè¡¨è¿ç§»å¤±è´¥ä½†æ— æ˜ç¡®é”™è¯¯

**åŸå› **ï¼šå¯èƒ½æ˜¯å­—ç¬¦é›†ã€æ’åºè§„åˆ™ç­‰æ•°æ®åº“é…ç½®é—®é¢˜

**è§£å†³**ï¼šæ£€æŸ¥æ•°æ®åº“é…ç½®ï¼Œç¡®ä¿ä½¿ç”¨ utf8mb4 å­—ç¬¦é›†

## ğŸ” è¿ç§»æ—¥å¿—ç¤ºä¾‹

```
========================================
ğŸš€ å¼€å§‹æ•°æ®åº“è¡¨è¿ç§»...
========================================
ğŸ“‹ è®¡åˆ’è¿ç§» 60 ä¸ªè¡¨ï¼š
  1. users                            (æ— ä¾èµ–)
  2. chats                            (æ— ä¾èµ–)
  3. themes                           (æ— ä¾èµ–)
  4. sessions                         (ä¾èµ–: [users])
  5. contacts                         (ä¾èµ–: [users])
  6. chat_members                     (ä¾èµ–: [chats users])
  7. message_replies                  (æ— ä¾èµ–)
  8. messages                         (ä¾èµ–: [users chats message_replies])
  ... æ›´å¤šè¡¨
----------------------------------------
â³ [1/60] è¿ç§»è¡¨: users
   âœ¨ åˆ›å»ºæ–°è¡¨: users
   âœ… è¿ç§»æˆåŠŸ: users
â³ [2/60] è¿ç§»è¡¨: chats
   âœ¨ åˆ›å»ºæ–°è¡¨: chats
   âœ… è¿ç§»æˆåŠŸ: chats
... ç»§ç»­è¿ç§»
----------------------------------------
âœ… æ•°æ®åº“è¿ç§»å®Œæˆï¼æˆåŠŸè¿ç§» 60/60 ä¸ªè¡¨
ğŸ” å¼€å§‹éªŒè¯è¡¨ç»“æ„...
âœ… æ•°æ®åº“éªŒè¯é€šè¿‡ï¼å½“å‰å…±æœ‰ 60 ä¸ªè¡¨
ğŸ“Š æ•°æ®åº“è¡¨åˆ—è¡¨ï¼š
  users                         sessions                      contacts
  chats                         chat_members                  messages
  ... æ›´å¤šè¡¨
========================================
```

## ğŸ“¦ æ–°å¢è¡¨æ—¶çš„æ³¨æ„äº‹é¡¹

### 1. æ·»åŠ æ–°æ¨¡å‹

```go
// im-backend/internal/model/your_model.go
type YourModel struct {
    ID        uint      `gorm:"primaryKey" json:"id"`
    UserID    uint      `gorm:"not null;index" json:"user_id"`
    Name      string    `gorm:"type:varchar(100);not null" json:"name"`
    CreatedAt time.Time `json:"created_at"`
    
    // å…³è”
    User User `gorm:"foreignKey:UserID" json:"user,omitempty"`
}
```

### 2. æ·»åŠ åˆ°è¿ç§»åˆ—è¡¨

åœ¨ `config/database_migration.go` çš„ `GetMigrationOrder()` å‡½æ•°ä¸­æ·»åŠ ï¼š

```go
// æ ¹æ®ä¾èµ–å…³ç³»é€‰æ‹©åˆé€‚çš„ä½ç½®
{Model: &model.YourModel{}, Name: "your_models", Deps: []string{"users"}},
```

### 3. è¿è¡Œæµ‹è¯•

```bash
cd im-backend/config
go test -v
```

### 4. éªŒè¯è¿ç§»

```bash
cd im-backend
go run main.go
# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤è¡¨åˆ›å»ºæˆåŠŸ
```

## ğŸ› ï¸ ç»´æŠ¤æŒ‡å—

### å®šæœŸæ£€æŸ¥

1. **æ£€æŸ¥è¿ç§»é¡ºåº**ï¼šç¡®ä¿æ–°è¡¨çš„ä¾èµ–å…³ç³»æ­£ç¡®
2. **è¿è¡Œå•å…ƒæµ‹è¯•**ï¼šæ¯æ¬¡ä¿®æ”¹åè¿è¡Œæµ‹è¯•
3. **æ£€æŸ¥å­—æ®µé•¿åº¦**ï¼šæ–°å¢å­—æ®µæ—¶æ˜ç¡®æŒ‡å®šé•¿åº¦
4. **éªŒè¯å¤–é”®**ï¼šç¡®ä¿å¤–é”®å¼•ç”¨çš„è¡¨å·²åœ¨ä¾èµ–åˆ—è¡¨ä¸­

### æ€§èƒ½ä¼˜åŒ–

1. **ç´¢å¼•ä¼˜åŒ–**ï¼šåˆç†æ·»åŠ ç´¢å¼•ï¼Œé¿å…è¿‡å¤šç´¢å¼•
2. **æ‰¹é‡è¿ç§»**ï¼šä½¿ç”¨äº‹åŠ¡æ‰¹é‡åˆ›å»ºè¡¨
3. **ç¼“å­˜æœºåˆ¶**ï¼šç¼“å­˜è¡¨å­˜åœ¨æ£€æŸ¥ç»“æœ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [GORM å®˜æ–¹æ–‡æ¡£](https://gorm.io/docs/)
- [MySQL å¤–é”®çº¦æŸ](https://dev.mysql.com/doc/refman/8.0/en/create-table-foreign-keys.html)
- [æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–](https://dev.mysql.com/doc/refman/8.0/en/optimization-indexes.html)

## ğŸ’¡ æœ€ä½³å®è·µ

1. âœ… æ€»æ˜¯æ˜ç¡®æŒ‡å®š varchar é•¿åº¦
2. âœ… è¢«å¼•ç”¨çš„è¡¨å¿…é¡»å…ˆåˆ›å»º
3. âœ… ä½¿ç”¨ uniqueIndex æ—¶ç¡®ä¿å­—æ®µé•¿åº¦åˆç†
4. âœ… æ¯æ¬¡ä¿®æ”¹æ¨¡å‹åè¿è¡Œå•å…ƒæµ‹è¯•
5. âœ… éƒ¨ç½²å‰åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¿ç§»
6. âœ… ç”Ÿäº§ç¯å¢ƒå…ˆå¤‡ä»½æ•°æ®åº“
7. âœ… ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†æ•°æ®åº“å˜æ›´

## ğŸ” å®‰å…¨å»ºè®®

1. **å¤‡ä»½ä¼˜å…ˆ**ï¼šç”Ÿäº§ç¯å¢ƒè¿ç§»å‰å¿…é¡»å¤‡ä»½
2. **æµ‹è¯•å…ˆè¡Œ**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†æµ‹è¯•
3. **æ—¥å¿—ç›‘æ§**ï¼šå…³æ³¨è¿ç§»æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
4. **å›æ»šæ–¹æ¡ˆ**ï¼šå‡†å¤‡æ•°æ®åº“å›æ»šè„šæœ¬
5. **åˆ†æ­¥è¿ç§»**ï¼šå¤§è§„æ¨¡å˜æ›´åˆ†å¤šæ¬¡è¿›è¡Œ

---

**ç»´æŠ¤è€…**: å¿—èˆªå¯†ä¿¡å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-09  
**ç‰ˆæœ¬**: v1.6.0

