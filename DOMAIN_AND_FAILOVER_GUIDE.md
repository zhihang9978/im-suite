# 域名与故障转移完整指南

**问题**: 灾难转移时，如何让用户自动切换到副服务器？

**答案**: 有两种方案，取决于您的服务器部署位置

---

## 🎯 两种故障转移方案对比

| 方案 | 适用场景 | 是否需要域名 | 切换速度 | 成本 |
|------|----------|--------------|----------|------|
| **方案1: 虚拟IP (Keepalived)** | 同机房/同局域网 | ❌ 不需要 | < 5秒 | 0元 |
| **方案2: DNS故障转移** | 不同地区 | ✅ **需要** | 1-5分钟 | 域名费用 |

---

## 方案 1: 虚拟 IP (Keepalived) - 同机房部署

### 适用条件
```
✅ 主服务器和副服务器在同一机房
✅ 两台服务器在同一局域网
✅ 可以使用虚拟IP（VIP）
```

### 工作原理
```
用户 → 虚拟IP (10.0.0.100)
         ↓
    ┌────┴────┐
    │ 主服务器 │ ✅ 正常时绑定虚拟IP
    └─────────┘
         ↓ 主服务器宕机
    ┌────┴────┐
    │ 副服务器 │ ✅ 自动接管虚拟IP
    └─────────┘
```

### 客户端配置
```javascript
// 移动端或Web客户端配置
const API_BASE_URL = "http://10.0.0.100:8080";

// 用户始终访问虚拟IP
// 无需修改客户端代码
```

### 优点
- ✅ **不需要域名**（节省成本）
- ✅ 切换速度极快（< 5秒）
- ✅ 完全自动化，用户无感知
- ✅ 配置简单

### 缺点
- ❌ 只能在同一局域网使用
- ❌ 不能跨地区部署
- ❌ 虚拟IP通常是内网IP

**⚠️ 重要**: 如果要通过互联网访问，需要配置公网IP + 端口转发，或者使用域名

---

## 方案 2: DNS 故障转移 - 跨地区部署（推荐）

### 适用条件
```
✅ 主服务器和副服务器在不同地区
✅ 需要通过互联网访问
✅ 希望用户使用友好的域名
✅ 需要异地容灾
```

### 工作原理
```
用户 → 域名 (api.yourdomain.com)
         ↓
    DNS 解析服务
         ↓
    ┌────┴────┐
    │ 主服务器 │ 154.37.214.191 ✅ 健康检查通过
    └─────────┘
         ↓ 主服务器宕机（健康检查失败）
    DNS 自动切换
         ↓
    ┌────┴────┐
    │ 副服务器 │ 副服务器IP ✅ 自动切换
    └─────────┘
```

### 需要购买的服务

#### 1. 域名（必须）
```
推荐域名商:
- 阿里云: https://wanwang.aliyun.com
- 腾讯云: https://dnspod.cloud.tencent.com
- Cloudflare: https://www.cloudflare.com

域名选择:
- yourdomain.com
- yourapp.com
- yourbrand.cn

价格: 约50-100元/年
```

#### 2. DNS 解析服务（可选但推荐）
```
免费服务:
✅ Cloudflare (推荐) - 免费，支持健康检查
✅ 阿里云DNS (免费版) - 基础功能
✅ 腾讯云DNSPod (免费版) - 基础功能

付费服务（支持自动故障转移）:
- 阿里云DNS付费版: 约300元/年
- Cloudflare Pro: 约$20/月
```

### 配置步骤

#### 步骤 1: 购买域名
```bash
# 1. 访问域名商网站
# 2. 搜索并购买域名（如 zhihang-messenger.com）
# 3. 完成实名认证（中国大陆需要）
```

#### 步骤 2: 配置 DNS 解析（以阿里云为例）

**方式 A: 简单配置（手动切换）**
```
主机记录: api
记录类型: A
记录值: 154.37.214.191 (主服务器IP)
TTL: 60秒 (减少缓存时间，加快切换)

结果: api.yourdomain.com → 154.37.214.191
```

**主服务器故障时手动切换**:
```
登录DNS控制台 → 修改A记录
记录值: 154.37.214.191 → 副服务器IP
保存 → 等待1-5分钟DNS生效
```

**方式 B: 自动故障转移（推荐，需付费）**
```
使用阿里云智能解析或Cloudflare:

1. 配置主记录
   主机记录: api
   记录类型: A
   记录值: 154.37.214.191
   解析线路: 默认
   健康检查: 启用
   检查URL: http://154.37.214.191:8080/health
   
2. 配置备用记录
   主机记录: api
   记录类型: A
   记录值: 副服务器IP
   解析线路: 备用
   权重: 0 (主服务器正常时不分配流量)
   
3. 故障转移策略
   当主服务器健康检查失败时:
   - 自动将流量切换到副服务器
   - 切换时间: 1-5分钟
   - 用户自动重连到新服务器
```

#### 步骤 3: 配置客户端

**移动端配置**:
```kotlin
// Android 客户端
object Config {
    // 使用域名，不要用IP
    const val API_BASE_URL = "https://api.yourdomain.com"
    const val WS_BASE_URL = "wss://api.yourdomain.com/ws"
}

// 用户无需关心服务器切换
// DNS自动解析到正确的服务器
```

**Web 客户端配置**:
```javascript
// web 客户端
const API_BASE_URL = "https://api.yourdomain.com";
const WS_BASE_URL = "wss://api.yourdomain.com/ws";

// 用户访问统一域名
// 故障时自动切换到副服务器
```

### 优点
- ✅ **支持跨地区部署**（异地容灾）
- ✅ 用户访问友好域名
- ✅ 可以自动故障转移（付费DNS）
- ✅ 支持HTTPS（更安全）
- ✅ 可以使用CDN加速

### 缺点
- ❌ 需要购买域名（约50-100元/年）
- ❌ 切换速度较慢（1-5分钟）
- ❌ 依赖DNS缓存，可能延迟
- ❌ 自动切换需要付费DNS服务

---

## 🎯 推荐方案选择

### 场景 1: 测试/开发阶段
```
方案: 直接使用IP + 端口
配置: http://154.37.214.191:8080
优点: 免费，快速
缺点: 不友好，不适合生产

建议: ✅ 暂时使用，测试完成后购买域名
```

### 场景 2: 小规模生产（< 1000用户）
```
方案: 域名 + 手动切换
配置: 
  - 购买域名（约60元/年）
  - 配置A记录指向主服务器
  - 主服务器故障时手动修改DNS
  
优点: 成本低，简单
缺点: 需要手动切换（1-5分钟恢复）

建议: ✅ 适合初期，可以接受短暂中断
```

### 场景 3: 中大规模生产（> 1000用户）
```
方案: 域名 + 自动DNS故障转移
配置:
  - 购买域名（约60元/年）
  - 使用付费DNS服务（约300元/年）
  - 配置健康检查和自动切换
  
优点: 完全自动化，无需人工干预
缺点: 成本稍高

建议: ✅✅ 强烈推荐，生产环境标配
```

### 场景 4: 同机房高可用
```
方案: Keepalived + 虚拟IP + 域名（混合）
配置:
  - 两台服务器用虚拟IP（内网）
  - 购买域名指向虚拟IP的公网映射
  - Keepalived管理虚拟IP切换
  
优点: 切换速度最快（< 5秒）+ 友好域名
缺点: 需要同机房

建议: ✅✅✅ 最佳方案（如果服务器同机房）
```

---

## 💰 成本分析

### 方案对比

| 项目 | 不用域名 | 域名+手动 | 域名+自动 |
|------|----------|-----------|-----------|
| **域名** | 0元 | 60元/年 | 60元/年 |
| **DNS服务** | 0元 | 0元(免费版) | 300元/年 |
| **主服务器** | 800元/月 | 800元/月 | 800元/月 |
| **副服务器** | 800元/月 | 800元/月 | 800元/月 |
| **监控服务器** | 400元/月 | 400元/月 | 400元/月 |
| **月成本** | 2000元 | 2005元 | 2025元 |
| **年成本** | 24000元 | 24060元 | 24360元 |
| **切换方式** | 手动改IP | 手动改DNS | 自动 |
| **切换时间** | 立即 | 1-5分钟 | 1-5分钟 |

**结论**: 域名成本很低（约0.3%），但带来巨大价值！

---

## 📋 我的建议（根据您的情况）

### 现在（测试阶段）
```
✅ 不需要购买域名
✅ 直接使用IP测试功能
✅ 移动端和Web端配置主服务器IP

配置:
const API_URL = "http://154.37.214.191:8080";
```

### 测试完成后（准备上线）
```
✅✅ 强烈建议购买域名！

理由:
1. 成本很低（约60元/年）
2. 用户体验好（zhihang-messenger.com vs 154.37.214.191）
3. 支持故障转移（手动或自动）
4. 可以配置HTTPS（更安全）
5. 便于品牌宣传
6. 移动端审核更容易通过

推荐购买:
- zhihang-messenger.com
- 或 im-zhihang.com
- 或 您喜欢的其他域名
```

### 正式运营（用户 > 100）
```
✅✅✅ 必须购买域名 + 付费DNS服务

配置建议:
1. 域名: yourdomain.com (60元/年)
2. DNS: 阿里云智能解析企业版 (300元/年)
   或 Cloudflare Pro ($240/年)
3. 健康检查: 每分钟检查一次
4. 自动切换: 主服务器故障时自动切换到副服务器

结果:
- 用户始终访问 api.yourdomain.com
- 主服务器故障时，1-5分钟内自动切换
- 用户无感知（可能只需重连一次）
```

---

## 🔧 完整配置示例（推荐方案）

### 1. 购买域名（阿里云）
```
访问: https://wanwang.aliyun.com
搜索: zhihang-messenger.com
价格: 约60元/年
购买并完成实名认证
```

### 2. 配置 Cloudflare（免费自动故障转移）

#### 注册并添加域名
```
1. 注册 Cloudflare: https://cloudflare.com
2. 添加站点: zhihang-messenger.com
3. 修改域名DNS服务器指向Cloudflare
   (在域名注册商处修改)
```

#### 配置DNS记录
```
记录1 (主服务器):
  类型: A
  名称: api
  IPv4地址: 154.37.214.191
  代理状态: 已代理 (橙色云)
  TTL: 自动
  
记录2 (副服务器):
  类型: A
  名称: api-backup
  IPv4地址: 副服务器IP
  代理状态: 已代理
  TTL: 自动
```

#### 配置健康检查（免费版）
```
1. 在Cloudflare中进入 "流量" → "负载均衡"
2. 创建健康检查:
   监控URL: http://154.37.214.191:8080/health
   检查间隔: 60秒
   失败阈值: 3次
   
3. 创建负载均衡器:
   主机名: api.zhihang-messenger.com
   源服务器池:
     - 主服务器: 154.37.214.191 (权重100)
     - 副服务器: 副服务器IP (权重0)
   
   故障转移策略:
   - 主服务器健康检查失败 → 自动切换到副服务器
   - 主服务器恢复 → 自动切换回主服务器
```

### 3. 配置客户端

#### Android 客户端
```kotlin
// app/src/main/java/config/AppConfig.kt
object AppConfig {
    const val API_BASE_URL = "https://api.zhihang-messenger.com"
    const val WS_BASE_URL = "wss://api.zhihang-messenger.com/ws"
}
```

#### Web 客户端
```javascript
// src/config.js
export const config = {
  API_BASE_URL: "https://api.zhihang-messenger.com",
  WS_BASE_URL: "wss://api.zhihang-messenger.com/ws"
};
```

#### 管理后台
```javascript
// im-admin/src/config.js
export const API_BASE_URL = "https://api.zhihang-messenger.com";
```

### 4. 配置 HTTPS（免费）
```
Cloudflare 自动提供免费SSL证书！

在 Cloudflare 控制台:
1. SSL/TLS → 概述 → 加密模式: 完全(严格)
2. 边缘证书 → 自动HTTPS重写: 开启
3. 最低TLS版本: TLS 1.2

结果:
- http://api.zhihang-messenger.com → 自动跳转到 https://
- 用户始终使用加密连接
```

---

## ✅ 完整部署流程（带域名）

### 阶段 1: 测试（现在）
```bash
# 不需要域名
# 直接使用 IP 测试所有功能
API: http://154.37.214.191:8080
Web: http://154.37.214.191:3002
Admin: http://154.37.214.191:3001
```

### 阶段 2: 购买域名和配置
```bash
1. 购买域名（约60元/年）
2. 配置 Cloudflare（免费）
3. 添加DNS记录
4. 等待DNS生效（24-48小时）
5. 配置HTTPS
```

### 阶段 3: 更新客户端配置
```bash
1. 修改客户端配置使用域名
2. 重新构建并发布客户端
3. 用户更新到新版本
4. 逐步迁移到域名访问
```

### 阶段 4: 三服务器部署
```bash
1. 购买副服务器和监控服务器
2. 按照 THREE_SERVER_DEPLOYMENT_GUIDE.md 部署
3. 配置DNS负载均衡和健康检查
4. 测试故障转移
5. 正式上线
```

---

## 🎯 最终推荐

### ✅ 推荐配置（性价比最高）

```
成本: 约 2025元/月 (2000元服务器 + 25元域名+DNS)

包含:
✅ 域名 (60元/年)
✅ Cloudflare免费版 (自动故障转移)
✅ 主服务器 (800元/月)
✅ 副服务器 (800元/月)
✅ 监控服务器 (400元/月)
✅ 免费SSL证书
✅ 免费CDN加速

效果:
✅ 99.9% 可用性
✅ 自动故障转移（1-5分钟）
✅ HTTPS安全连接
✅ 用户友好域名
✅ 全球CDN加速
```

### 购买建议

**立即购买**:
```
✅ 域名 (60元/年)
   - 越早购买越好
   - 需要实名认证（3-5天）
   - 需要DNS生效（24-48小时）
   
建议域名:
1. zhihang-messenger.com
2. im-zhihang.com
3. zhihang-im.com
```

**暂缓购买**:
```
⏰ 付费DNS服务 (可以先用Cloudflare免费版)
⏰ CDN加速 (用户量大时再考虑)
⏰ 短信服务 (需要时再开通)
```

---

## 📞 总结

### 问题回答

**Q: 是不是还要购买域名？**  
**A**: ✅ **强烈建议购买！** 只需60元/年，但带来巨大价值。

**Q: 灾难转移用户到副服务器？**  
**A**: ✅ **是的！** 通过DNS自动故障转移实现。

**Q: 客户端绑定域名就可以切换？**  
**A**: ✅ **完全正确！** 客户端配置域名，服务器切换对用户透明。

### 行动建议

**现在（测试阶段）**:
- ✅ 暂时不买域名，用IP测试
- ✅ 完成功能测试和Bug修复

**1周内（准备上线）**:
- ✅✅ 购买域名（立即！需要实名+DNS生效）
- ✅ 注册Cloudflare并配置DNS
- ✅ 配置健康检查

**测试完成后（正式上线）**:
- ✅ 部署三服务器架构
- ✅ 更新客户端配置使用域名
- ✅ 测试故障转移
- ✅ 正式运营

---

**结论**: 域名是必须的，而且成本很低（约60元/年）！建议尽早购买，因为需要时间实名认证和DNS生效。🚀

文档: 
- THREE_SERVER_DEPLOYMENT_GUIDE.md (三服务器部署)
- ACTIVE_PASSIVE_HA_ARCHITECTURE.md (架构设计)

